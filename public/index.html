<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SillyTavern Viewer</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ === */
  :root {
      --bg: #1e1e1e; --text: #eee; --panel: #252529; --accent: #fa5252;
      --msg-user: #303035; --msg-bot: #2b2b30; --border: #3a3a3a;
  }
  body { margin:0; font-family: sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
  
  /* === ë ˆì´ì•„ì›ƒ === */
  #sidebar { width: 300px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
  #main { flex: 1; display: flex; flex-direction: column; position: relative; }
  
  /* === ë¦¬ìŠ¤íŠ¸ === */
  .list-header { padding: 15px; border-bottom: 1px solid var(--border); font-weight: bold; background: #2a2a2e;}
  .char-list, .chat-list { overflow-y: auto; flex: 1; }
  .item { padding: 12px 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; flex-direction: column; gap: 4px; }
  .item:hover { background: #333; }
  .item.active { background: #3a3a40; border-left: 3px solid var(--accent); }
  
  .item-title { font-weight: bold; font-size: 0.95rem; }
  .item-meta { font-size: 0.75rem; color: #aaa; display: flex; justify-content: space-between; align-items: center;}
  
  /* íƒœê·¸ ìŠ¤íƒ€ì¼ */
  .tag-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
  .tag { background: #444; color: #ccc; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
  .tag-edit-btn { background: none; border: none; color: #777; cursor: pointer; font-size: 0.8rem; }
  .tag-edit-btn:hover { color: var(--accent); }

  /* === ì±„íŒ… ë·°ì–´ === */
  #chat-view { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
  
  /* ë©”ì‹œì§€ ë°•ìŠ¤ */
  .message { background: var(--msg-bot); padding: 15px; border-radius: 8px; max-width: 800px; margin: 0 auto; width: 100%; border: 1px solid var(--border); }
  .message.user { background: var(--msg-user); border-color: #444; }
  .mes-name { font-weight: bold; margin-bottom: 8px; color: var(--accent); display: block; }
  .mes-text { line-height: 1.6; white-space: pre-wrap; }
  .mes-text p { margin: 0 0 10px 0; }
  
  /* === ì´ë¯¸ì§€ (SillyTavern ìŠ¤íƒ€ì¼) === */
  .mes_media_wrapper { margin-top: 10px; width: 100%; }
  .mes_media_container { position: relative; display: inline-block; max-width: 100%; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
  .mes_img { display: block; max-width: 100%; height: auto; max-height: 500px; }
  
  /* === ëª¨ë‹¬ (íƒœê·¸ í¸ì§‘) === */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
  .modal { background: var(--panel); padding: 20px; border-radius: 8px; width: 300px; border: 1px solid var(--border); }
  .modal h3 { margin-top: 0; }
  .modal input { width: 100%; padding: 8px; background: #111; border: 1px solid #444; color: white; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box; }
  .modal-btns { display: flex; justify-content: flex-end; gap: 8px; }
  .btn { padding: 6px 12px; cursor: pointer; border-radius: 4px; border: none; }
  .btn.save { background: var(--accent); color: white; }
  
  /* ìœ í‹¸ */
  .hidden { display: none !important; }
  .back-btn { padding: 10px; background: #333; cursor: pointer; text-align: center; border-bottom: 1px solid #444; }
</style>
</head>
<body>

<div id="sidebar">
  <div id="char-list-panel">
    <div class="list-header">ğŸ“‚ ìºë¦­í„° ëª©ë¡</div>
    <div class="char-list" id="charList"></div>
  </div>
  
  <div id="chat-list-panel" class="hidden">
    <div class="back-btn" onclick="showCharList()">â† ë’¤ë¡œê°€ê¸°</div>
    <div class="list-header" id="chatListHeader">ì±„íŒ… íŒŒì¼</div>
    <div class="chat-list" id="chatList"></div>
  </div>
</div>

<main id="main">
  <div id="chat-view">
    <div style="text-align:center; color:#555; margin-top:100px;">ì±„íŒ…ì„ ì„ íƒí•˜ì„¸ìš”</div>
  </div>
</main>

<div class="modal-overlay" id="tagModal">
  <div class="modal">
    <h3>íƒœê·¸ í¸ì§‘</h3>
    <p id="tagTargetName" style="font-size:0.8rem; color:#aaa; margin-bottom:10px;"></p>
    <input type="text" id="tagInput" placeholder="íƒœê·¸ ì…ë ¥ (ì‰¼í‘œë¡œ êµ¬ë¶„)">
    <div class="modal-btns">
      <button class="btn" onclick="closeTagModal()">ì·¨ì†Œ</button>
      <button class="btn save" onclick="saveTags()">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
  let state = {
    characters: {},
    imageMap: {},
    currentChar: null,
    currentFile: null,
    editingFile: null // íƒœê·¸ í¸ì§‘ ì¤‘ì¸ íŒŒì¼ëª…
  };

  // ì´ˆê¸° ë¡œë“œ
  async function init() {
    const res = await fetch('/api/scan');
    const data = await res.json();
    state.characters = data.characters;
    state.imageMap = data.imageMap || {};
    renderCharList();
  }

  // ìºë¦­í„° ëª©ë¡ ë Œë”ë§
  function renderCharList() {
    const list = document.getElementById('charList');
    list.innerHTML = Object.keys(state.characters).map(name => `
      <div class="item" onclick="selectChar('${name}')">
        <div class="item-title">${name}</div>
        <div class="item-meta">${state.characters[name].chats.length}ê°œì˜ ì±„íŒ…</div>
      </div>
    `).join('');
  }

  function showCharList() {
    document.getElementById('char-list-panel').classList.remove('hidden');
    document.getElementById('chat-list-panel').classList.add('hidden');
    state.currentChar = null;
  }

  // ì±„íŒ… íŒŒì¼ ëª©ë¡ ë Œë”ë§ (íƒœê·¸ í¬í•¨)
  function selectChar(name) {
    state.currentChar = name;
    document.getElementById('char-list-panel').classList.add('hidden');
    document.getElementById('chat-list-panel').classList.remove('hidden');
    document.getElementById('chatListHeader').innerText = `${name}ì˜ ì±„íŒ…`;
    
    const chats = state.characters[name].chats.sort((a,b) => b.modified.localeCompare(a.modified));
    const list = document.getElementById('chatList');
    
    list.innerHTML = chats.map(chat => {
      const tagsHtml = chat.tags.map(t => `<span class="tag">${t}</span>`).join('');
      return `
        <div class="item" onclick="loadChat('${chat.file}')">
          <div class="item-title">${chat.name}</div>
          <div class="tag-container">
            ${tagsHtml}
            <button class="tag-edit-btn" onclick="event.stopPropagation(); openTagModal('${chat.file}')">
              <i class="fa-solid fa-tag"></i>
            </button>
          </div>
          <div class="item-meta">${new Date(chat.modified).toLocaleDateString()} Â· ${(chat.size/1024).toFixed(1)}KB</div>
        </div>
      `;
    }).join('');
  }

  // ì±„íŒ… ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadChat(fileName) {
    state.currentFile = fileName;
    const charName = state.currentChar;
    const view = document.getElementById('chat-view');
    view.innerHTML = '<div style="text-align:center; padding:20px;">ë¡œë”© ì¤‘...</div>';

    const res = await fetch(`/api/chat?char=${encodeURIComponent(charName)}&file=${encodeURIComponent(fileName)}`);
    const data = await res.json();
    
    view.innerHTML = '';
    
    data.messages.forEach(msg => {
      const el = document.createElement('div');
      el.className = `message ${msg.is_user ? 'user' : 'bot'}`;
      
      let html = `<span class="mes-name">${msg.name}</span>`;
      html += `<div class="mes-text">${formatText(msg.mes)}</div>`;

      // â˜… ì´ë¯¸ì§€ ë Œë”ë§ ë¶€ë¶„ â˜…
      if (msg.extra && msg.extra.image) {
        let imgSrc = '';
        
        // 1. ì´ë¯¸ì§€ê°€ base64ì¸ ê²½ìš°
        if (msg.extra.image.startsWith('data:')) {
            imgSrc = msg.extra.image;
        } 
        // 2. íŒŒì¼ëª…ë§Œ ìˆëŠ” ê²½ìš° (imageMapì—ì„œ ì°¾ê¸°)
        else if (state.imageMap[msg.extra.image]) {
            imgSrc = `/api/image?path=${encodeURIComponent(state.imageMap[msg.extra.image])}`;
        }
        // 3. ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš°
        else {
            // ê·¸ëƒ¥ ê²½ë¡œë¥¼ ì„œë²„ì— ìš”ì²­í•´ë´„ (ì„œë²„ê°€ ê¶Œí•œ ìˆìœ¼ë©´ ì¤Œ)
            imgSrc = `/api/image?path=${encodeURIComponent(msg.extra.image)}`;
        }

        if (imgSrc) {
            html += `
            <div class="mes_media_wrapper">
                <div class="mes_media_container">
                    <img class="mes_img" src="${imgSrc}" loading="lazy">
                </div>
            </div>`;
        }
      }

      el.innerHTML = html;
      view.appendChild(el);
    });
  }

  // í…ìŠ¤íŠ¸ í¬ë§·íŒ… (ë§ˆí¬ë‹¤ìš´ ê°„ëµ ì²˜ë¦¬)
  function formatText(text) {
    if(!text) return '';
    return text
      .replace(/</g, '&lt;')
      .replace(/\n/g, '<br>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>');
  }

  // --- íƒœê·¸ ê´€ë¦¬ í•¨ìˆ˜ ---

  function openTagModal(fileName) {
    state.editingFile = fileName;
    const chat = state.characters[state.currentChar].chats.find(c => c.file === fileName);
    document.getElementById('tagTargetName').innerText = fileName;
    document.getElementById('tagInput').value = chat.tags.join(', ');
    document.getElementById('tagModal').style.display = 'flex';
  }

  function closeTagModal() {
    document.getElementById('tagModal').style.display = 'none';
  }

  async function saveTags() {
    const input = document.getElementById('tagInput').value;
    const tags = input.split(',').map(t => t.trim()).filter(Boolean);
    const charName = state.currentChar;
    const fileName = state.editingFile;

    await fetch('/api/tags', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ char: charName, file: fileName, tags: tags })
    });

    // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
    const chat = state.characters[charName].chats.find(c => c.file === fileName);
    chat.tags = tags;
    selectChar(charName); // ëª©ë¡ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    closeTagModal();
  }

  init();
</script>
</body>
</html>
