<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ï±ÑÌåÖ ÎèÑÏÑúÍ¥Ä</title>
<style>
/* ============================================================
   Chat Library ‚Äî Renewed Theme (Í∞ÄÎèÖÏÑ± Í∞úÏÑ†)
   ============================================================ */

@font-face {
  font-family: 'RIDIBatang';
  src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.0/RIDIBatang.woff') format('woff');
  font-weight: normal;
  font-display: swap;
}
@font-face {
  font-family: 'SpoqaHanSans';
  font-weight: 400;
  src: url('https://cdn.jsdelivr.net/gh/spoqa/spoqa-han-sans@01ff0283e4f36e159ffbf744b36e16ef742da6d8/Subset/SpoqaHanSans/SpoqaHanSansRegular.woff2') format('woff2');
  font-display: swap;
}
@font-face {
  font-family: 'Pretendard';
  font-weight: 400;
  src: url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard/Pretendard-Regular.subset.woff2') format('woff2');
  font-display: swap;
}
@font-face {
  font-family: 'Pretendard';
  font-weight: 600;
  src: url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard/Pretendard-SemiBold.subset.woff2') format('woff2');
  font-display: swap;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f8f6f2;
  --bg-warm: #f3f0ea;
  --surface: #ffffff;
  --surface-alt: #faf9f7;
  --text: #2c2c2c;
  --text-secondary: #6b6b6b;
  --text-dim: #999;
  --border: #e0ddd7;
  --border-strong: #c8c4bc;
  --accent: #5a7d6a;
  --accent-light: #e8f0eb;
  --accent-hover: #4a6b5a;
  --tag-bg: #eee8dd;
  --tag-text: #7a6b55;
  --user-bg: #f0f4ff;
  --user-border: #d0d8ee;
  --bot-bg: #fffef9;
  --bot-border: #e8e4d8;
  --shadow: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-lg: 0 4px 16px rgba(0,0,0,0.1);
  --font-body: 'Pretendard', 'SpoqaHanSans', -apple-system, sans-serif;
  --font-reading: 'RIDIBatang', 'Pretendard', serif;
  --font-size: 14px;
  --line-height: 1.8;
  --radius: 8px;
  --radius-sm: 5px;
  --radius-lg: 12px;
  --scrollbar-w: 5px;
  --topbar-h: 54px;
  --sidebar-w: 280px;
}

html { font-size: var(--font-size); }
body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  line-height: var(--line-height);
  min-height: 100dvh;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

::-webkit-scrollbar { width: var(--scrollbar-w); height: var(--scrollbar-w); }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

/* ===== LAYOUT ===== */
#app {
  display: grid;
  grid-template-rows: var(--topbar-h) 1fr;
  grid-template-columns: var(--sidebar-w) 1fr;
  height: 100dvh;
  width: 100%;
}

/* ===== TOP BAR ===== */
#topbar {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  padding: 0 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  gap: 16px;
  z-index: 100;
}

.topbar-title {
  display: flex;
  align-items: baseline;
  gap: 8px;
  cursor: pointer;
  user-select: none;
  min-width: 0;
}
.topbar-title:hover .title-edit-hint { opacity: 1; }

#libraryName {
  font-family: var(--font-reading);
  font-size: 1.15rem;
  font-weight: normal;
  white-space: nowrap;
  letter-spacing: 0.5px;
  color: var(--text);
}

#libraryNameInput {
  font-family: var(--font-reading);
  font-size: 1.15rem;
  font-weight: normal;
  border: none;
  border-bottom: 2px solid var(--accent);
  background: transparent;
  outline: none;
  padding: 0 2px;
  color: var(--text);
  width: 200px;
}

.title-edit-hint {
  font-size: 0.7rem;
  color: var(--text-dim);
  opacity: 0;
  transition: opacity 0.2s;
}

.topbar-actions {
  margin-left: auto;
  display: flex;
  gap: 8px;
  align-items: center;
}

/* ===== BUTTONS ===== */
.btn {
  font-family: var(--font-body);
  font-size: 0.82rem;
  padding: 7px 14px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: all 0.15s;
  white-space: nowrap;
  font-weight: 500;
}
.btn:hover { background: var(--bg-warm); border-color: var(--border-strong); box-shadow: var(--shadow); }
.btn:active { transform: translateY(1px); }
.btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn.primary:hover { background: var(--accent-hover); }
.btn.small { padding: 5px 10px; font-size: 0.78rem; }
.btn.ghost { border: none; background: none; color: var(--text-secondary); }
.btn.ghost:hover { background: var(--accent-light); color: var(--accent); }

/* ===== SIDEBAR ===== */
#sidebar {
  background: var(--surface);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.sidebar-section { padding: 12px 14px; }
.sidebar-section + .sidebar-section { border-top: 1px solid var(--border); }

.sidebar-title {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 1.8px;
  color: var(--text-dim);
  margin-bottom: 8px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}
.sidebar-title::before {
  content: '';
  width: 3px;
  height: 12px;
  background: var(--accent);
  border-radius: 2px;
  flex-shrink: 0;
}

/* Search */
.search-box {
  width: 100%;
  font-family: var(--font-body);
  font-size: 0.85rem;
  padding: 8px 12px;
  border: 1px solid var(--border);
  background: var(--surface-alt);
  border-radius: var(--radius-sm);
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.search-box:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
.search-box::placeholder { color: var(--text-dim); }

/* Tag filter */
.tag-filter-section { padding: 8px 14px; }
.tag-filter-list {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-top: 6px;
}
.tag-filter-chip {
  font-size: 0.72rem;
  padding: 3px 8px;
  border-radius: 12px;
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-secondary);
  transition: all 0.15s;
  user-select: none;
}
.tag-filter-chip:hover { background: var(--accent-light); border-color: var(--accent); }
.tag-filter-chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.tag-filter-chip.hide-mode { background: #f5e6e6; color: #a55; border-color: #daa; }

/* Character list */
.char-list { list-style: none; }
.char-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: all 0.12s;
  margin-bottom: 2px;
}
.char-item:hover { background: var(--accent-light); }
.char-item.active { background: var(--accent-light); box-shadow: inset 3px 0 0 var(--accent); }
.char-item.hidden-by-tag { display: none; }

.char-avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: 2px solid var(--border);
  object-fit: cover;
  flex-shrink: 0;
  background: var(--bg-warm);
}

.char-info { min-width: 0; flex: 1; }
.char-name { font-size: 0.88rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.char-meta { font-size: 0.7rem; color: var(--text-dim); margin-top: 1px; }
.char-tags {
  display: flex;
  gap: 3px;
  flex-wrap: wrap;
  margin-top: 2px;
}
.char-tag-badge {
  font-size: 0.62rem;
  padding: 1px 5px;
  border-radius: 8px;
  background: var(--tag-bg);
  color: var(--tag-text);
}

.chat-count {
  font-size: 0.68rem;
  background: var(--accent-light);
  color: var(--accent);
  padding: 2px 7px;
  border-radius: 10px;
  flex-shrink: 0;
  font-weight: 600;
}

/* ===== MAIN AREA ===== */
#main {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
  background: var(--bg);
}

/* Chat list */
#chat-list-panel {
  display: none;
  flex-direction: column;
  overflow: hidden;
  height: 100%;
}
.chat-list-header {
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--surface);
  flex-shrink: 0;
}
.chat-list-header h2 { font-size: 1rem; font-weight: 600; }
.chat-entries { flex: 1; overflow-y: auto; padding: 16px 20px; }

.chat-entry {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 16px;
  border: 1px solid var(--border);
  background: var(--surface);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.15s;
}
.chat-entry:hover { box-shadow: var(--shadow-md); border-color: var(--accent); transform: translateY(-1px); }

.chat-entry-icon { font-size: 1.3rem; flex-shrink: 0; width: 36px; text-align: center; opacity: 0.7; }
.chat-entry-info { flex: 1; min-width: 0; }
.chat-entry-name { font-weight: 600; font-size: 0.88rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.chat-entry-date { font-size: 0.72rem; color: var(--text-dim); margin-top: 3px; }
.chat-entry-preview { font-size: 0.78rem; color: var(--text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 500px; }
.chat-entry-msgs {
  font-size: 0.68rem;
  background: var(--accent-light);
  color: var(--accent);
  padding: 3px 9px;
  border-radius: 10px;
  flex-shrink: 0;
  font-weight: 600;
}

/* ===== CHAT VIEWER ===== */
#chat-viewer {
  display: none;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}
.chat-viewer-header {
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--surface);
  flex-shrink: 0;
}
.chat-viewer-header h2 { font-size: 0.95rem; font-weight: 600; flex: 1; }

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  max-width: 800px;
  width: 100%;
  margin: 0 auto;
}

/* Message bubbles */
.message {
  margin-bottom: 20px;
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid var(--bot-border);
  background: var(--bot-bg);
}
.message.user {
  background: var(--user-bg);
  border-color: var(--user-border);
}

.mes-avatar-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  background: rgba(0,0,0,0.02);
  border-bottom: 1px solid rgba(0,0,0,0.04);
}
.message.user .mes-avatar-wrapper { flex-direction: row-reverse; }

.mes-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 1.5px solid var(--border);
  object-fit: cover;
  flex-shrink: 0;
  background: var(--bg-warm);
}

.mes-name { font-size: 0.82rem; font-weight: 600; flex: 1; color: var(--text); }
.message.user .mes-name { text-align: right; }
.mes-time { font-size: 0.68rem; color: var(--text-dim); }

.mes-body {
  padding: 14px 18px 16px;
  font-family: var(--font-reading);
  font-size: 0.92rem;
  line-height: 1.95;
  color: var(--text);
  word-break: break-word;
}
.mes-body p { margin-bottom: 12px; }
.mes-body p:last-child { margin-bottom: 0; }
.mes-body em { color: var(--text-secondary); font-style: italic; }
.mes-body strong { font-weight: 700; }
.mes-body blockquote {
  background: var(--bg-warm);
  border-left: 3px solid var(--accent);
  padding: 8px 14px;
  margin: 8px 0;
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  color: var(--text-secondary);
}
.mes-body code {
  background: var(--bg-warm);
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 0.88em;
  border: 1px solid var(--border);
}

/* Ï†ïÍ∑úÏãùÏúºÎ°ú Ïïà Í±∏Îü¨ÏßÑ ÌÉúÍ∑∏Î•º CSSÎ°ú Ïà®ÍπÄ */
.mes-body .hidden-tag { display: none !important; }

.mes-image-container { padding: 6px 18px 12px; display: flex; justify-content: center; }
.mes-image {
  max-width: 50%;
  max-height: 420px;
  object-fit: contain;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
.mes-image:hover { transform: scale(1.02); box-shadow: var(--shadow-md); }

.mes-swipe-info {
  font-size: 0.68rem;
  color: var(--text-dim);
  text-align: center;
  padding: 4px 0 8px;
}

/* ===== WELCOME ===== */
#welcome {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  padding: 40px 20px;
  text-align: center;
}
.welcome-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.6; }
.welcome-title { font-family: var(--font-reading); font-size: 1.6rem; margin-bottom: 8px; color: var(--text); }
.welcome-desc { font-size: 0.9rem; color: var(--text-secondary); max-width: 440px; line-height: 1.8; margin-bottom: 28px; }

.drop-zone {
  border: 2px dashed var(--border-strong);
  border-radius: var(--radius-lg);
  padding: 36px 48px;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--surface);
  max-width: 480px;
  width: 100%;
}
.drop-zone:hover, .drop-zone.drag-over {
  background: var(--accent-light);
  border-color: var(--accent);
  box-shadow: var(--shadow-md);
}
.drop-zone-text { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.7; }
.drop-zone-text strong { color: var(--text); }

.welcome-server-status {
  margin-top: 20px;
  font-size: 0.8rem;
  color: var(--text-dim);
  display: flex;
  align-items: center;
  gap: 6px;
}
.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text-dim);
}
.status-dot.online { background: var(--accent); }

/* ===== GALLERY ===== */
#gallery-panel {
  display: none;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}
.gallery-header {
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--surface);
  flex-shrink: 0;
}
.gallery-header h2 { font-size: 1rem; font-weight: 600; flex: 1; }

.gallery-content { flex: 1; overflow-y: auto; padding: 16px 20px; }

.gallery-folder {
  margin-bottom: 24px;
}
.gallery-folder-header {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 8px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 10px;
  user-select: none;
  transition: background 0.15s;
}
.gallery-folder-header:hover { background: var(--accent-light); }
.gallery-folder-header .folder-icon { font-size: 1rem; transition: transform 0.2s; }
.gallery-folder-header.collapsed .folder-icon { transform: rotate(-90deg); }
.gallery-folder-header .folder-name { font-weight: 600; font-size: 0.88rem; flex: 1; }
.gallery-folder-header .folder-count { font-size: 0.72rem; color: var(--text-dim); }

.gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 10px;
  align-content: start;
}
.gallery-folder.collapsed .gallery-grid { display: none; }

.gallery-item {
  border: 1px solid var(--border);
  background: var(--surface);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: all 0.15s;
  overflow: hidden;
}
.gallery-item:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }

.gallery-thumb {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  display: block;
  background: var(--bg-warm);
}
.gallery-item-info { padding: 6px 8px; }
.gallery-item-name { font-size: 0.68rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-dim); }

/* ===== TAG MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 5000;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }

.modal {
  background: var(--surface);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  width: 340px;
  max-width: 90vw;
  padding: 24px;
}
.modal h3 { font-size: 1rem; margin-bottom: 16px; }
.modal-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 16px;
  min-height: 30px;
}
.modal-tag {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.78rem;
  padding: 4px 10px;
  border-radius: 14px;
  background: var(--tag-bg);
  color: var(--tag-text);
}
.modal-tag .remove-tag {
  cursor: pointer;
  font-size: 0.9rem;
  opacity: 0.6;
  transition: opacity 0.15s;
  line-height: 1;
}
.modal-tag .remove-tag:hover { opacity: 1; color: #c33; }

.modal-input-row {
  display: flex;
  gap: 6px;
  margin-bottom: 16px;
}
.modal-input-row input {
  flex: 1;
  font-family: var(--font-body);
  font-size: 0.85rem;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  outline: none;
}
.modal-input-row input:focus { border-color: var(--accent); }

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

/* ===== LIGHTBOX ===== */
.lightbox {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.88);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}
.lightbox.open { display: flex; }
.lightbox img { max-width: 92vw; max-height: 92vh; object-fit: contain; border-radius: 4px; }
.lightbox-close { position: absolute; top: 16px; right: 20px; font-size: 2rem; color: white; cursor: pointer; opacity: 0.7; }
.lightbox-close:hover { opacity: 1; }

/* ===== STATS BAR ===== */
.stats-bar {
  padding: 8px 20px;
  background: var(--surface);
  border-top: 1px solid var(--border);
  font-size: 0.72rem;
  color: var(--text-dim);
  flex-shrink: 0;
}

/* ===== EMPTY & LOADING ===== */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-dim);
  font-size: 0.9rem;
  gap: 8px;
}
.empty-state-icon { font-size: 2rem; opacity: 0.4; }

.loading { display: flex; align-items: center; justify-content: center; height: 100%; gap: 10px; color: var(--text-dim); }
@keyframes spin { to { transform: rotate(360deg); } }
.spinner { width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; }

/* ===== MOBILE ===== */
.sidebar-toggle {
  display: none;
  font-size: 1.2rem;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text);
  padding: 4px;
}

@media (max-width: 700px) {
  #app { grid-template-columns: 1fr; }
  #sidebar {
    position: fixed;
    left: calc(-1 * var(--sidebar-w));
    top: var(--topbar-h);
    bottom: 0;
    width: var(--sidebar-w);
    z-index: 200;
    transition: left 0.25s ease;
    box-shadow: none;
  }
  #sidebar.open { left: 0; box-shadow: 4px 0 20px rgba(0,0,0,0.12); }
  .sidebar-toggle { display: block; }
  .mes-image { max-width: 85%; }
  .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
  .mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 199; }
  .mobile-overlay.show { display: block; }
  .chat-messages { padding: 12px; }
}

/* ===== TOAST ===== */
.toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; }
.toast {
  padding: 10px 18px;
  background: var(--text);
  color: var(--surface);
  font-family: var(--font-body);
  font-size: 0.8rem;
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-md);
  margin-top: 6px;
  animation: toastIn 0.3s ease;
}
.toast.error { background: #c44; }
@keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

/* ===== HINT ===== */
.hint-text { font-size: 0.72rem; color: var(--text-dim); padding: 6px 0; line-height: 1.5; }
</style>
</head>
<body>

<div id="app">
  <!-- TOP BAR -->
  <header id="topbar">
    <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Î©îÎâ¥">‚ò∞</button>
    <div class="topbar-title" onclick="startEditTitle()">
      <span id="libraryName">Ï±ÑÌåÖ ÎèÑÏÑúÍ¥Ä</span>
      <span class="title-edit-hint">‚úé</span>
    </div>
    <div class="topbar-actions">
      <button class="btn small ghost" onclick="showGallery()">üñº Í∞§Îü¨Î¶¨</button>
      <button class="btn small primary" onclick="triggerFileInput()">Ôºã ÌååÏùº Ï∂îÍ∞Ä</button>
    </div>
  </header>

  <!-- SIDEBAR -->
  <nav id="sidebar">
    <div class="sidebar-section">
      <input type="text" class="search-box" placeholder="Ï∫êÎ¶≠ÌÑ∞ Í≤ÄÏÉâ..." id="searchBox" oninput="filterCharacters()">
    </div>

    <!-- ÌÉúÍ∑∏ ÌïÑÌÑ∞ -->
    <div class="sidebar-section tag-filter-section" id="tagFilterSection" style="display:none;">
      <div class="sidebar-title">ÌÉúÍ∑∏ ÌïÑÌÑ∞</div>
      <div class="tag-filter-list" id="tagFilterList"></div>
    </div>

    <div class="sidebar-section" style="flex:1; overflow-y:auto; padding-top:4px;">
      <div class="sidebar-title">ÏÑúÏû¨</div>
      <ul class="char-list" id="charList"></ul>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-title">ÌÜµÍ≥Ñ</div>
      <div id="sidebarStats" class="hint-text">ÌååÏùºÏùÑ Î∂àÎü¨ÏôÄ Ï£ºÏÑ∏Ïöî</div>
    </div>
  </nav>

  <!-- MOBILE OVERLAY -->
  <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

  <!-- MAIN CONTENT -->
  <main id="main">
    <div id="welcome">
      <div class="welcome-icon">üìö</div>
      <div class="welcome-title" id="welcomeTitle">Ï±ÑÌåÖ ÎèÑÏÑúÍ¥Ä</div>
      <div class="welcome-desc">
        Î∞±ÏóÖÌïú SillyTavern Ï±ÑÌåÖ ÌååÏùº(.jsonl)Í≥º Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨ÏôÄÏÑú<br>
        ÎèÑÏÑúÍ¥ÄÏ≤òÎüº Ïó¥ÎûåÌï† Ïàò ÏûàÏñ¥Ïöî.
      </div>
      <div class="drop-zone" id="dropZone"
           ondragover="handleDragOver(event)"
           ondragleave="handleDragLeave(event)"
           ondrop="handleDrop(event)"
           onclick="triggerFileInput()">
        <div class="drop-zone-text">
          <strong>ÌååÏùº/Ìè¥ÎçîÎ•º Ïó¨Í∏∞Ïóê ÎìúÎûòÍ∑∏</strong><br>
          ÎòêÎäî ÌÅ¥Î¶≠Ìï¥ÏÑú ÏÑ†ÌÉù<br><br>
          <span style="font-size:0.78rem">.jsonl (Ï±ÑÌåÖ) ¬∑ .png .jpg .webp (Ïù¥ÎØ∏ÏßÄ)</span>
        </div>
      </div>
      <div class="welcome-server-status" id="serverStatus">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">ÏÑúÎ≤Ñ ÌôïÏù∏ Ï§ë...</span>
      </div>
    </div>

    <div id="chat-list-panel">
      <div class="chat-list-header">
        <button class="btn small" onclick="goHome()">‚Üê ÏÑúÏû¨</button>
        <h2 id="chatListTitle">Ï±ÑÌåÖ Î™©Î°ù</h2>
        <button class="btn small ghost" onclick="openTagModal(state.currentChar)" title="ÌÉúÍ∑∏ Í¥ÄÎ¶¨">üè∑Ô∏è</button>
      </div>
      <div class="chat-entries" id="chatEntries"></div>
    </div>

    <div id="chat-viewer">
      <div class="chat-viewer-header">
        <button class="btn small" onclick="goBackToList()">‚Üê Î™©Î°ù</button>
        <h2 id="chatViewerTitle">Ï±ÑÌåÖ</h2>
        <span class="mes-time" id="chatViewerDate"></span>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="stats-bar" id="chatStats"></div>
    </div>

    <div id="gallery-panel">
      <div class="gallery-header">
        <button class="btn small" onclick="goHome()">‚Üê ÏÑúÏû¨</button>
        <h2>üñº Ïù¥ÎØ∏ÏßÄ Í∞§Îü¨Î¶¨</h2>
        <span class="mes-time" id="galleryCount"></span>
      </div>
      <div class="gallery-content" id="galleryContent"></div>
    </div>
  </main>
</div>

<!-- Hidden file input -->
<input type="file" id="fileInput" multiple accept=".jsonl,.json,.png,.jpg,.jpeg,.webp,.gif" style="display:none" onchange="handleFileSelect(event)">

<!-- Tag Modal -->
<div class="modal-overlay" id="tagModal">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="tagModalTitle">ÌÉúÍ∑∏ Í¥ÄÎ¶¨</h3>
    <div class="modal-tags" id="tagModalTags"></div>
    <div class="modal-input-row">
      <input type="text" id="tagInput" placeholder="ÏÉà ÌÉúÍ∑∏ ÏûÖÎ†•..." onkeydown="if(event.key==='Enter')addTagFromInput()">
      <button class="btn small primary" onclick="addTagFromInput()">Ï∂îÍ∞Ä</button>
    </div>
    <div class="modal-actions">
      <button class="btn small" onclick="closeTagModal()">Îã´Í∏∞</button>
    </div>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <span class="lightbox-close">&times;</span>
  <img id="lightboxImg" src="" alt="">
</div>

<!-- Toast -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ===================================================================
// STATE
// ===================================================================
const state = {
  characters: {},   // { charName: { avatar, chats: [{ name, date, messages, file, msgCount }], tags: [] } }
  images: {},       // { filename: blobUrl }
  imageList: [],    // [ { name, url, dir } ]
  imageFolders: {}, // { dir: [{ name, url }] }
  tags: {},         // { charName: [tag1, tag2, ...] }
  currentChar: null,
  currentChat: null,
  serverMode: false,
  activeTagFilters: [],   // selected tag filters
  tagFilterMode: 'show',  // 'show' = show only tagged, 'hide' = hide tagged
  libraryName: 'Ï±ÑÌåÖ ÎèÑÏÑúÍ¥Ä',
};

// ===================================================================
// INIT
// ===================================================================
document.addEventListener('DOMContentLoaded', async () => {
  document.body.addEventListener('dragover', e => e.preventDefault());
  document.body.addEventListener('drop', e => { e.preventDefault(); handleDrop(e); });

  // Î°úÏª¨ ÏÑ§Ï†ï Î°úÎìú
  loadLocalSettings();

  // ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏãúÎèÑ
  try {
    const res = await fetch('/api/scan');
    if (res.ok) {
      const data = await res.json();
      state.serverMode = true;
      document.getElementById('statusDot').classList.add('online');
      document.getElementById('statusText').textContent = `ÏÑúÎ≤Ñ Ïó∞Í≤∞Îê® ‚Äî ${data.roots.length}Í∞ú Í≤ΩÎ°ú`;
      loadServerData(data);

      // ÏÑúÎ≤Ñ ÏÑ§Ï†ï Î°úÎìú
      try {
        const sRes = await fetch('/api/settings');
        if (sRes.ok) {
          const settings = await sRes.json();
          if (settings.libraryName) {
            state.libraryName = settings.libraryName;
            applyLibraryName();
          }
        }
      } catch(e) {}

      // Ïù¥ÎØ∏ÏßÄ Î°úÎìú
      try {
        const iRes = await fetch('/api/images');
        if (iRes.ok) {
          const iData = await iRes.json();
          state.imageList = iData.images || [];
          state.imageFolders = iData.folders || {};
          for (const img of state.imageList) {
            state.images[img.name] = img.url;
          }
        }
      } catch(e) {}

      renderSidebar();
      updateStats();

      if (Object.keys(state.characters).length > 0) {
        document.getElementById('welcome').style.display = 'none';
      }
    } else {
      throw new Error('not ok');
    }
  } catch (e) {
    document.getElementById('statusDot').classList.remove('online');
    document.getElementById('statusText').textContent = 'Ïò§ÌîÑÎùºÏù∏ Î™®Îìú ‚Äî ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏Ìï¥ÏÑú Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî';
  }
});

function loadServerData(data) {
  for (const [name, info] of Object.entries(data.characters)) {
    state.characters[name] = {
      avatar: info.avatar || null,
      chats: info.chats.map(c => ({
        name: c.name,
        date: c.modified,
        file: c.file,
        msgCount: 0,
        messages: [],
        serverFile: true,
      })),
      tags: info.tags || [],
    };
    state.tags[name] = info.tags || [];
  }
  buildTagFilterList();
}

// ===================================================================
// LIBRARY NAME
// ===================================================================
function applyLibraryName() {
  document.getElementById('libraryName').textContent = state.libraryName;
  document.getElementById('welcomeTitle').textContent = state.libraryName;
  document.title = state.libraryName;
}

function startEditTitle() {
  const container = document.querySelector('.topbar-title');
  const span = document.getElementById('libraryName');
  const current = span.textContent;

  const input = document.createElement('input');
  input.id = 'libraryNameInput';
  input.value = current;
  input.maxLength = 30;

  span.style.display = 'none';
  container.querySelector('.title-edit-hint').style.display = 'none';
  container.insertBefore(input, span);
  input.focus();
  input.select();

  const finish = () => {
    const val = input.value.trim() || 'Ï±ÑÌåÖ ÎèÑÏÑúÍ¥Ä';
    state.libraryName = val;
    span.textContent = val;
    span.style.display = '';
    container.querySelector('.title-edit-hint').style.display = '';
    if (input.parentNode) input.remove();
    applyLibraryName();
    saveLibraryName();
  };

  input.onblur = finish;
  input.onkeydown = (e) => { if (e.key === 'Enter') finish(); if (e.key === 'Escape') { input.value = current; finish(); } };
  container.onclick = null;
  setTimeout(() => container.onclick = () => startEditTitle(), 300);
}

function saveLibraryName() {
  localStorage.setItem('chatlib-name', state.libraryName);
  if (state.serverMode) {
    fetch('/api/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ libraryName: state.libraryName }),
    }).catch(() => {});
  }
}

function loadLocalSettings() {
  const name = localStorage.getItem('chatlib-name');
  if (name) { state.libraryName = name; applyLibraryName(); }
  const tags = localStorage.getItem('chatlib-tags');
  if (tags) { try { state.tags = JSON.parse(tags); } catch(e) {} }
}

// ===================================================================
// TAG SYSTEM
// ===================================================================
function openTagModal(charName) {
  if (!charName) return;
  state._tagEditChar = charName;
  document.getElementById('tagModalTitle').textContent = charName + ' ‚Äî ÌÉúÍ∑∏';
  document.getElementById('tagInput').value = '';
  renderTagModalTags();
  document.getElementById('tagModal').classList.add('open');
  setTimeout(() => document.getElementById('tagInput').focus(), 100);
}

function closeTagModal() {
  document.getElementById('tagModal').classList.remove('open');
}

function renderTagModalTags() {
  const charName = state._tagEditChar;
  const tags = state.tags[charName] || [];
  const container = document.getElementById('tagModalTags');
  if (tags.length === 0) {
    container.innerHTML = '<span style="font-size:0.78rem;color:var(--text-dim)">ÌÉúÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§</span>';
    return;
  }
  container.innerHTML = tags.map((t, i) =>
    `<span class="modal-tag">${escHtml(t)}<span class="remove-tag" onclick="removeTag(${i})">√ó</span></span>`
  ).join('');
}

function addTagFromInput() {
  const input = document.getElementById('tagInput');
  const tag = input.value.trim();
  if (!tag || !state._tagEditChar) return;
  if (!state.tags[state._tagEditChar]) state.tags[state._tagEditChar] = [];
  if (!state.tags[state._tagEditChar].includes(tag)) {
    state.tags[state._tagEditChar].push(tag);
  }
  if (state.characters[state._tagEditChar]) {
    state.characters[state._tagEditChar].tags = state.tags[state._tagEditChar];
  }
  input.value = '';
  renderTagModalTags();
  saveTags();
  renderSidebar();
  buildTagFilterList();
}

function removeTag(idx) {
  const charName = state._tagEditChar;
  if (!state.tags[charName]) return;
  state.tags[charName].splice(idx, 1);
  if (state.characters[charName]) {
    state.characters[charName].tags = state.tags[charName];
  }
  renderTagModalTags();
  saveTags();
  renderSidebar();
  buildTagFilterList();
}

function saveTags() {
  localStorage.setItem('chatlib-tags', JSON.stringify(state.tags));
  if (state.serverMode) {
    fetch('/api/tags', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(state.tags),
    }).catch(() => {});
  }
}

function buildTagFilterList() {
  const allTags = new Set();
  for (const tags of Object.values(state.tags)) {
    for (const t of tags) allTags.add(t);
  }

  const section = document.getElementById('tagFilterSection');
  const list = document.getElementById('tagFilterList');

  if (allTags.size === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = '';
  list.innerHTML = Array.from(allTags).sort().map(t => {
    const isActive = state.activeTagFilters.includes(t);
    return `<span class="tag-filter-chip ${isActive ? 'active' : ''}" onclick="toggleTagFilter('${escHtml(t)}')">${escHtml(t)}</span>`;
  }).join('') + `<span class="tag-filter-chip ${state.activeTagFilters.length > 0 ? '' : ''}" onclick="clearTagFilters()" style="border-style:dashed;">Ï†ÑÏ≤¥</span>`;
}

function toggleTagFilter(tag) {
  const idx = state.activeTagFilters.indexOf(tag);
  if (idx >= 0) state.activeTagFilters.splice(idx, 1);
  else state.activeTagFilters.push(tag);
  buildTagFilterList();
  filterCharacters();
}

function clearTagFilters() {
  state.activeTagFilters = [];
  buildTagFilterList();
  filterCharacters();
}

// ===================================================================
// FILE HANDLING
// ===================================================================
function triggerFileInput() { document.getElementById('fileInput').click(); }
function handleDragOver(e) { e.preventDefault(); if (e.currentTarget.classList) e.currentTarget.classList.add('drag-over'); }
function handleDragLeave(e) { if (e.currentTarget.classList) e.currentTarget.classList.remove('drag-over'); }

async function handleDrop(e) {
  e.preventDefault();
  const dz = document.getElementById('dropZone');
  if (dz) dz.classList.remove('drag-over');
  const items = e.dataTransfer?.items;
  if (!items) return;
  const files = [];
  const promises = [];
  for (const item of items) {
    const entry = item.webkitGetAsEntry?.();
    if (entry) promises.push(traverseEntry(entry, files));
  }
  await Promise.all(promises);
  if (files.length === 0) for (const f of e.dataTransfer.files) files.push(f);
  processFiles(files);
}

function traverseEntry(entry, files) {
  return new Promise(resolve => {
    if (entry.isFile) entry.file(f => { files.push(f); resolve(); });
    else if (entry.isDirectory) {
      entry.createReader().readEntries(async entries => {
        for (const e of entries) await traverseEntry(e, files);
        resolve();
      });
    } else resolve();
  });
}

function handleFileSelect(e) { processFiles(Array.from(e.target.files)); e.target.value = ''; }

async function processFiles(files) {
  let chatCount = 0, imgCount = 0;
  for (const file of files) {
    const name = file.name.toLowerCase();
    if (name.endsWith('.jsonl')) { await parseChatFile(file); chatCount++; }
    else if (name.endsWith('.json') && !name.includes('settings') && !name.includes('theme')) { await parseChatFile(file); chatCount++; }
    else if (/\.(png|jpg|jpeg|webp|gif)$/i.test(name)) {
      const u = URL.createObjectURL(file);
      state.images[file.name] = u;
      // Ìè¥Îçî Ï†ïÎ≥¥ Ï∂îÏ∂ú
      const rp = file.webkitRelativePath || '';
      const parts = rp.split('/');
      const dir = parts.length >= 2 ? parts[parts.length - 2] : '';
      state.imageList.push({ name: file.name, url: u, dir });
      if (!state.imageFolders[dir || 'Í∏∞ÌÉÄ']) state.imageFolders[dir || 'Í∏∞ÌÉÄ'] = [];
      state.imageFolders[dir || 'Í∏∞ÌÉÄ'].push({ name: file.name, url: u });

      for (const cn of Object.keys(state.characters)) {
        if (file.name.toLowerCase().includes(normalizeForMatch(cn))) {
          if (!state.characters[cn].avatar) state.characters[cn].avatar = u;
        }
      }
      imgCount++;
    }
  }
  renderSidebar(); updateStats();
  if (chatCount > 0 || imgCount > 0) toast(`${chatCount}Í∞ú Ï±ÑÌåÖ ¬∑ ${imgCount}Í∞ú Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏôÑÎ£å`);
  if (Object.keys(state.characters).length > 0) document.getElementById('welcome').style.display = 'none';
}

// ‚îÄ‚îÄ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï†ïÍ∑úÏãù ÌïÑÌÑ∞ ‚îÄ‚îÄ
const CLIENT_CLEANUP_REGEXES = [
  { find: /(?:```?\w*[\r\n]?)?<(thought|cot|thinking|CoT|think|starter)[\s\S]*?<\/(thought|cot|thinking|CoT|think|starter)>(?:[\r\n]?```?)?/gi, replace: '' },
  { find: /<pic>[\s\S]*?<\/pic>/gi, replace: '' },
  { find: /<imageInfo>[\s\S]*?<\/imageInfo>/gi, replace: '' },
  { find: /<pic\s+prompt="[^"]*"\s*>/gi, replace: '' },
  { find: /<\/pic>/gi, replace: '' },
  { find: /‚ûõ/g, replace: '' },
  { find: /ü•® Sex Position[\s\S]*?(?=```)/g, replace: '' },
  { find: /\[OOC:[\s\S]*?\]/gi, replace: '' },
  { find: /<OOC>[\s\S]*?<\/OOC>/gi, replace: '' },
  { find: /<extra_prompt>[\s\S]*?<\/extra_prompt>/gi, replace: '' },
  { find: /<s>[\s\S]*?<\/system>/gi, replace: '' },
];

function clientCleanMessage(text) {
  if (!text) return '';
  let c = text;
  for (const r of CLIENT_CLEANUP_REGEXES) c = c.replace(r.find, r.replace);
  return c.replace(/\n{3,}/g, '\n\n').trim();
}

function normalizeForMatch(str) {
  return str.toLowerCase().replace(/[''"`\s_\-\.]/g, '').replace(/[^a-z0-9Í∞Ä-Ìû£„Ñ±-„Öé„Öè-„Ö£]/g, '');
}

async function parseChatFile(file) {
  const text = await file.text();
  const lines = text.trim().split('\n');
  if (lines.length === 0) return;

  const messages = [];
  let chatName = file.name.replace(/\.jsonl?$/, '');
  let charName = '';
  let chatDate = '';

  for (const line of lines) {
    try {
      const msg = JSON.parse(line.trim());
      if (!charName && msg.name && !msg.is_user) charName = msg.name;
      if (!charName && msg.character_name) charName = msg.character_name;
      if (!charName) {
        const parts = (file.webkitRelativePath || '').split('/');
        if (parts.length >= 2) charName = parts[parts.length - 2];
      }
      if (!chatDate && (msg.send_date || msg.create_date)) chatDate = msg.send_date || msg.create_date;

      messages.push({
        name: msg.name || (msg.is_user ? 'ÏÇ¨Ïö©Ïûê' : charName || '???'),
        is_user: !!msg.is_user,
        mes: clientCleanMessage(msg.mes || ''),
        send_date: msg.send_date || msg.create_date || '',
        extra: msg.extra || {},
        swipe_id: msg.swipe_id,
        swipes: msg.swipes,
      });
    } catch (e) {}
  }
  if (messages.length === 0) return;
  if (!charName) { const d = chatName.indexOf(' - '); charName = d > 0 ? chatName.substring(0, d) : chatName; }
  charName = charName.replace(/\.png$/i, '');

  if (!state.characters[charName]) state.characters[charName] = { avatar: null, chats: [], tags: state.tags[charName] || [] };
  state.characters[charName].chats.push({ name: chatName, date: chatDate, messages, file: file.name, msgCount: messages.length });
}

// ===================================================================
// RENDERING
// ===================================================================
function renderSidebar() {
  const list = document.getElementById('charList');
  const chars = Object.entries(state.characters).sort((a, b) => {
    const aT = a[1].chats.reduce((s, c) => s + (c.msgCount || c.messages?.length || 0), 0);
    const bT = b[1].chats.reduce((s, c) => s + (c.msgCount || c.messages?.length || 0), 0);
    return bT - aT;
  });

  list.innerHTML = chars.map(([name, data]) => {
    const cnt = data.chats.length;
    const total = data.chats.reduce((s, c) => s + (c.msgCount || c.messages?.length || 0), 0);
    const tags = data.tags || state.tags[name] || [];
    const tagBadges = tags.map(t => `<span class="char-tag-badge">${escHtml(t)}</span>`).join('');

    const avatarHtml = data.avatar
      ? `<img class="char-avatar" src="${data.avatar}" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="char-avatar" style="display:none;align-items:center;justify-content:center;font-size:1rem;">${name.charAt(0)}</div>`
      : `<div class="char-avatar" style="display:flex;align-items:center;justify-content:center;font-size:1rem;">${name.charAt(0)}</div>`;

    return `
      <li class="char-item ${state.currentChar === name ? 'active' : ''}"
          onclick="selectCharacter('${escAttr(name)}')"
          data-name="${escAttr(name.toLowerCase())}"
          data-tags="${escAttr(tags.join(',').toLowerCase())}">
        ${avatarHtml}
        <div class="char-info">
          <div class="char-name">${escHtml(name)}</div>
          <div class="char-meta">${cnt}Í∞ú Ï±ÑÌåÖ</div>
          ${tagBadges ? `<div class="char-tags">${tagBadges}</div>` : ''}
        </div>
        <span class="chat-count">${total}</span>
      </li>
    `;
  }).join('');

  filterCharacters();
}

function filterCharacters() {
  const q = (document.getElementById('searchBox')?.value || '').toLowerCase();
  const activeTags = state.activeTagFilters;

  document.querySelectorAll('.char-item').forEach(el => {
    const name = el.dataset.name || '';
    const tags = (el.dataset.tags || '').split(',').filter(Boolean);

    let nameMatch = !q || name.includes(q);
    let tagMatch = true;

    if (activeTags.length > 0) {
      tagMatch = activeTags.some(t => tags.includes(t.toLowerCase()));
    }

    el.style.display = (nameMatch && tagMatch) ? '' : 'none';
  });
}

function selectCharacter(name) {
  state.currentChar = name;
  state.currentChat = null;
  renderSidebar();

  const data = state.characters[name];
  if (!data) return;

  hideAllPanels();
  document.getElementById('chat-list-panel').style.display = 'flex';
  document.getElementById('chatListTitle').textContent = name;

  const entries = document.getElementById('chatEntries');
  const sorted = [...data.chats].sort((a, b) => (b.date || '').localeCompare(a.date || ''));

  entries.innerHTML = sorted.map((chat, idx) => {
    const preview = chat.messages?.length > 1 ? chat.messages[1].mes?.substring(0, 100) : '';
    const dateStr = chat.date ? formatDate(chat.date) : 'ÎÇ†Ïßú Î∂àÎ™Ö';
    const realIdx = data.chats.indexOf(chat);

    return `
      <div class="chat-entry" onclick="openChat('${escAttr(name)}', ${realIdx})">
        <div class="chat-entry-icon">üìñ</div>
        <div class="chat-entry-info">
          <div class="chat-entry-name">${escHtml(chat.name)}</div>
          <div class="chat-entry-date">${dateStr}</div>
          ${preview ? `<div class="chat-entry-preview">${escHtml(preview)}</div>` : ''}
        </div>
        <span class="chat-entry-msgs">${chat.msgCount || chat.messages?.length || '?'}ÌÑ¥</span>
      </div>
    `;
  }).join('');

  closeSidebarMobile();
}

async function openChat(charName, chatIdx) {
  const data = state.characters[charName];
  if (!data || !data.chats[chatIdx]) return;

  state.currentChat = chatIdx;
  const chat = data.chats[chatIdx];

  // ÏÑúÎ≤ÑÎ™®ÎìúÎ©¥ APIÏóêÏÑú Î©îÏãúÏßÄ Î°úÎìú
  if (chat.serverFile && (!chat.messages || chat.messages.length === 0)) {
    try {
      const res = await fetch(`/api/chat?char=${encodeURIComponent(charName)}&file=${encodeURIComponent(chat.file)}`);
      if (res.ok) {
        const cData = await res.json();
        chat.messages = cData.messages;
        chat.msgCount = cData.messages.length;
        if (cData.avatar && !data.avatar) data.avatar = cData.avatar;
      }
    } catch (e) {
      toast('Ï±ÑÌåÖ Î°úÎìú Ïã§Ìå®', 'error');
      return;
    }
  }

  hideAllPanels();
  document.getElementById('chat-viewer').style.display = 'flex';
  document.getElementById('chatViewerTitle').textContent = charName;
  document.getElementById('chatViewerDate').textContent = chat.date ? formatDate(chat.date) : '';

  const container = document.getElementById('chatMessages');
  container.innerHTML = '';

  let userMsgs = 0, botMsgs = 0;
  for (const msg of chat.messages) {
    container.appendChild(createMessageElement(msg, data.avatar));
    if (msg.is_user) userMsgs++; else botMsgs++;
  }

  document.getElementById('chatStats').textContent = `Ï¥ù ${chat.messages.length}ÌÑ¥ ¬∑ ÏÇ¨Ïö©Ïûê ${userMsgs} ¬∑ AI ${botMsgs}`;
  container.scrollTop = 0;
}

function createMessageElement(msg, charAvatar) {
  const div = document.createElement('div');
  div.className = `message ${msg.is_user ? 'user' : 'bot'}`;

  const avatarWrapper = document.createElement('div');
  avatarWrapper.className = 'mes-avatar-wrapper';

  if (msg.is_user) {
    const av = document.createElement('div');
    av.className = 'mes-avatar';
    av.style.cssText = 'display:flex;align-items:center;justify-content:center;font-size:0.9rem;';
    av.textContent = 'üë§';
    avatarWrapper.appendChild(av);
  } else if (charAvatar) {
    const img = document.createElement('img');
    img.className = 'mes-avatar';
    img.src = charAvatar;
    img.alt = '';
    img.onerror = function() {
      this.style.display = 'none';
      const fb = document.createElement('div');
      fb.className = 'mes-avatar';
      fb.style.cssText = 'display:flex;align-items:center;justify-content:center;font-size:0.9rem;';
      fb.textContent = msg.name?.charAt(0) || '?';
      this.parentNode.insertBefore(fb, this);
    };
    avatarWrapper.appendChild(img);
  } else {
    const av = document.createElement('div');
    av.className = 'mes-avatar';
    av.style.cssText = 'display:flex;align-items:center;justify-content:center;font-size:0.9rem;';
    av.textContent = msg.name?.charAt(0) || '?';
    avatarWrapper.appendChild(av);
  }

  const nameSpan = document.createElement('span');
  nameSpan.className = 'mes-name';
  nameSpan.textContent = msg.name;
  avatarWrapper.appendChild(nameSpan);

  if (msg.send_date) {
    const timeSpan = document.createElement('span');
    timeSpan.className = 'mes-time';
    timeSpan.textContent = formatTime(msg.send_date);
    avatarWrapper.appendChild(timeSpan);
  }

  div.appendChild(avatarWrapper);

  if (msg.extra && msg.extra.image) {
    const imgC = document.createElement('div');
    imgC.className = 'mes-image-container';
    const img = document.createElement('img');
    img.className = 'mes-image';
    if (typeof msg.extra.image === 'string' && msg.extra.image.startsWith('data:')) {
      img.src = msg.extra.image;
    } else {
      const found = findImage(msg.extra.image);
      if (found) img.src = found;
      else { img.style.display = 'none'; }
    }
    img.onclick = () => openLightbox(img.src);
    imgC.appendChild(img);
    div.appendChild(imgC);
  }

  const body = document.createElement('div');
  body.className = 'mes-body';
  body.innerHTML = formatMessage(msg.mes);
  div.appendChild(body);

  if (msg.swipes && msg.swipes > 1) {
    const si = document.createElement('div');
    si.className = 'mes-swipe-info';
    si.textContent = `Ïä§ÏôÄÏù¥ÌîÑ ${(msg.swipe_id || 0) + 1}/${msg.swipes}`;
    div.appendChild(si);
  }

  return div;
}

function formatMessage(text) {
  if (!text) return '';
  let html = escHtml(text);

  // Ï∂îÍ∞Ä CSS Í∏∞Î∞ò ÌÉúÍ∑∏ Ïà®ÍπÄ (Ï†ïÍ∑úÏãùÏúºÎ°ú Î™ª Ïû°ÏùÄ Í≤ÉÎì§)
  html = html.replace(/&lt;(imageInfo|ImageInfo|IMAGEINFO)&gt;[\s\S]*?&lt;\/(imageInfo|ImageInfo|IMAGEINFO)&gt;/gi, '');
  html = html.replace(/&lt;(pic|thinking|thought|cot|CoT|think|starter|OOC|extra_prompt)[\s\S]*?&lt;\/(pic|thinking|thought|cot|CoT|think|starter|OOC|extra_prompt)&gt;/gi, '');
  html = html.replace(/&lt;pic\s+prompt=&quot;[^&]*&quot;\s*&gt;/gi, '');
  html = html.replace(/&lt;\/pic&gt;/gi, '');

  // Markdown
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
  html = html.replace(/^&gt;(.+)$/gm, '<blockquote>$1</blockquote>');
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  html = html.replace(/\n/g, '<br>');
  html = html.replace(/(<br>){2,}/g, '</p><p>');
  html = '<p>' + html + '</p>';

  return html;
}

function findImage(filename) {
  if (!filename) return null;
  if (state.images[filename]) return state.images[filename];
  const lower = filename.toLowerCase();
  for (const [key, u] of Object.entries(state.images)) {
    if (key.toLowerCase().includes(lower) || lower.includes(key.toLowerCase())) return u;
  }
  return null;
}

// ===================================================================
// GALLERY (Ìè¥ÎçîÎ≥Ñ Î∂ÑÎ•ò)
// ===================================================================
function showGallery() {
  hideAllPanels();
  document.getElementById('gallery-panel').style.display = 'flex';
  document.getElementById('galleryCount').textContent = `${state.imageList.length}Í∞ú Ïù¥ÎØ∏ÏßÄ`;

  const content = document.getElementById('galleryContent');

  if (state.imageList.length === 0) {
    content.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üñº</div><div>Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§</div></div>`;
    return;
  }

  // Ìè¥ÎçîÎ≥Ñ Í∑∏Î£πÌôî
  const folders = {};
  for (const img of state.imageList) {
    const dir = img.dir || 'Í∏∞ÌÉÄ';
    if (!folders[dir]) folders[dir] = [];
    folders[dir].push(img);
  }

  const folderNames = Object.keys(folders).sort((a, b) => {
    if (a === 'Í∏∞ÌÉÄ') return 1;
    if (b === 'Í∏∞ÌÉÄ') return -1;
    return a.localeCompare(b);
  });

  content.innerHTML = folderNames.map(dir => {
    const imgs = folders[dir];
    return `
      <div class="gallery-folder" id="folder-${escAttr(dir)}">
        <div class="gallery-folder-header" onclick="toggleFolder(this)">
          <span class="folder-icon">‚ñæ</span>
          <span class="folder-name">üìÅ ${escHtml(dir)}</span>
          <span class="folder-count">${imgs.length}Í∞ú</span>
        </div>
        <div class="gallery-grid">
          ${imgs.map(img => `
            <div class="gallery-item" onclick="openLightbox('${img.url}')">
              <img class="gallery-thumb" src="${img.url}" alt="" loading="lazy">
              <div class="gallery-item-info">
                <div class="gallery-item-name">${escHtml(img.name)}</div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }).join('');
}

function toggleFolder(header) {
  const folder = header.parentElement;
  folder.classList.toggle('collapsed');
  header.classList.toggle('collapsed');
}

// ===================================================================
// NAVIGATION
// ===================================================================
function hideAllPanels() {
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('chat-list-panel').style.display = 'none';
  document.getElementById('chat-viewer').style.display = 'none';
  document.getElementById('gallery-panel').style.display = 'none';
}

function goHome() {
  state.currentChar = null;
  state.currentChat = null;
  renderSidebar();
  hideAllPanels();
  if (Object.keys(state.characters).length === 0 && state.imageList.length === 0) {
    document.getElementById('welcome').style.display = '';
  } else {
    document.getElementById('welcome').style.display = '';
  }
}

function goBackToList() {
  if (state.currentChar) selectCharacter(state.currentChar);
  else goHome();
}

// ===================================================================
// LIGHTBOX
// ===================================================================
function openLightbox(src) {
  if (!src) return;
  document.getElementById('lightboxImg').src = src;
  document.getElementById('lightbox').classList.add('open');
}
function closeLightbox() { document.getElementById('lightbox').classList.remove('open'); }

// ===================================================================
// SIDEBAR MOBILE
// ===================================================================
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('mobileOverlay').classList.toggle('show');
}
function closeSidebarMobile() {
  if (window.innerWidth <= 700) {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('mobileOverlay').classList.remove('show');
  }
}

// ===================================================================
// UTILS
// ===================================================================
function escHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}
function escAttr(str) {
  return escHtml(str).replace(/'/g, '&#039;');
}

function formatDate(dateStr) {
  try {
    if (!dateStr) return '';
    const d = new Date(dateStr.replace(/@/g, '').replace(/(\d+)h\s*(\d+)m\s*(\d+)s/, '$1:$2:$3'));
    if (isNaN(d.getTime())) return dateStr;
    return d.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
  } catch { return dateStr; }
}

function formatTime(dateStr) {
  try {
    if (!dateStr) return '';
    const d = new Date(dateStr.replace(/@/g, '').replace(/(\d+)h\s*(\d+)m\s*(\d+)s/, '$1:$2:$3'));
    if (isNaN(d.getTime())) return '';
    return d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
  } catch { return ''; }
}

function updateStats() {
  const charCount = Object.keys(state.characters).length;
  const chatCount = Object.values(state.characters).reduce((s, c) => s + c.chats.length, 0);
  const totalMsgs = Object.values(state.characters).reduce((s, c) =>
    s + c.chats.reduce((ss, ch) => ss + (ch.msgCount || ch.messages?.length || 0), 0), 0);
  const imgCount = state.imageList.length;
  document.getElementById('sidebarStats').innerHTML =
    `${charCount}Î™Ö Ï∫êÎ¶≠ÌÑ∞ ¬∑ ${chatCount}Í∞ú Ï±ÑÌåÖ<br>${totalMsgs.toLocaleString()}ÌÑ¥ ¬∑ ${imgCount}Í∞ú Ïù¥ÎØ∏ÏßÄ`;
}

function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeLightbox(); closeTagModal(); } });

// Click outside tag modal to close
document.getElementById('tagModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('tagModal')) closeTagModal();
});
</script>
</body>
</html>
