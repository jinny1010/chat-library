<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>ì±„íŒ… ë„ì„œê´€</title>
<style>
@font-face{font-family:'Batang';src:url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.0/RIDIBatang.woff') format('woff');font-display:swap}
@font-face{font-family:'Spoqa';src:url('https://cdn.jsdelivr.net/gh/spoqa/spoqa-han-sans@01ff0283e4f36e159ffbf744b36e16ef742da6d8/Subset/SpoqaHanSans/SpoqaHanSansRegular.woff2') format('woff2');font-display:swap}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --bg:#F5F3EF;--surface:#FFF;--text:#1B1C1E;--dim:#6B6B6B;--faint:#A8A5A0;
  --border:#1B1C1E;--border-l:rgba(27,28,30,.1);--hover:rgba(27,28,30,.05);
  --shadow:2px 2px 0 #1B1C1E;--shadow-s:1px 1px 0 rgba(27,28,30,.2);
  --font-ui:'Spoqa',sans-serif;--font-read:'Batang','Spoqa',serif;
  --topbar:48px;--side-w:240px;
}
html{font-size:14px}
body{font-family:var(--font-ui);background:var(--bg);color:var(--text);line-height:1.6;height:100dvh;overflow:hidden}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--border)}::-webkit-scrollbar-track{background:transparent}

/* â•â• LAYOUT â•â• */
#app{display:grid;grid-template-rows:var(--topbar) 1fr;grid-template-columns:var(--side-w) 1fr;height:100dvh}

/* â•â• TOPBAR â•â• */
.top{grid-column:1/-1;display:flex;align-items:center;padding:0 16px;background:var(--surface);border-bottom:1px solid var(--border);gap:10px;z-index:100}
.top-brand{font-size:.9rem;font-weight:700;white-space:nowrap}
.top-brand span{color:var(--dim);font-weight:400;font-size:.75rem;margin-left:4px}
.top-spacer{flex:1}
.top-btn{font-family:inherit;font-size:.72rem;padding:4px 10px;border:1px solid var(--border);background:var(--surface);cursor:pointer;box-shadow:var(--shadow-s);white-space:nowrap}
.top-btn:hover{background:var(--hover)}
.top-btn:active{box-shadow:none;transform:translate(1px,1px)}
.ham{display:none;background:0;border:0;font-size:1.1rem;cursor:pointer;color:var(--text);padding:2px 4px}

/* â•â• SIDEBAR â•â• */
.side{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.side-search{padding:10px 12px;border-bottom:1px solid var(--border-l)}
.side-search input{width:100%;font-family:inherit;font-size:.78rem;padding:5px 8px;border:1px solid var(--border);background:var(--surface);box-shadow:var(--shadow-s);outline:0}
.side-search input:focus{box-shadow:var(--shadow)}
.side-label{font-size:.6rem;text-transform:uppercase;letter-spacing:2px;color:var(--faint);padding:8px 12px 4px;position:relative}
.side-label::after{content:'';position:absolute;bottom:0;left:12px;right:12px;height:1px;background:var(--border-l)}
.side-list{flex:1;overflow-y:auto;list-style:none}
.si{display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;border-left:3px solid transparent;transition:all .1s}
.si:hover{background:var(--hover);border-left-color:var(--border-l)}
.si.on{background:var(--hover);border-left-color:var(--border)}
.si-av{width:30px;height:30px;border:1px solid var(--border);box-shadow:var(--shadow-s);object-fit:cover;flex-shrink:0;background:var(--bg)}
.si-ph{width:30px;height:30px;border:1px solid var(--border);box-shadow:var(--shadow-s);display:flex;align-items:center;justify-content:center;font-size:.75rem;background:var(--bg);color:var(--dim);flex-shrink:0}
.si-info{flex:1;min-width:0}
.si-name{font-size:.78rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.si-meta{font-size:.6rem;color:var(--faint)}
.si-badge{font-size:.58rem;color:var(--faint);border:1px solid var(--border-l);padding:0 4px;flex-shrink:0}
.side-foot{padding:8px 12px;border-top:1px solid var(--border-l);font-size:.6rem;color:var(--faint)}

/* â•â• MAIN â•â• */
.main{display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
.vw{display:none;flex-direction:column;height:100%;overflow:hidden}.vw.on{display:flex}

/* â•â• WELCOME â•â• */
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;gap:8px;color:var(--dim)}
.welcome b{font-size:1.1rem;color:var(--text)}

/* â•â• CHAT LIST â•â• */
.cl-head{padding:10px 16px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0}
.cl-head h2{font-size:.88rem;font-weight:600;flex:1}
.cl-tabs{display:flex;border-bottom:1px solid var(--border-l);background:var(--surface);flex-shrink:0}
.cl-tab{font-family:inherit;font-size:.72rem;padding:6px 14px;background:0;border:0;border-bottom:2px solid transparent;cursor:pointer;color:var(--dim)}
.cl-tab:hover{color:var(--text);background:var(--hover)}
.cl-tab.on{color:var(--text);border-bottom-color:var(--border)}
.cl-body{flex:1;overflow-y:auto;padding:12px 16px}

/* ì±„íŒ… ëª©ë¡ â€” ë¦¬ìŠ¤íŠ¸ í˜•íƒœ */
.chat-row{display:flex;align-items:center;gap:12px;padding:10px 12px;border:1px solid var(--border-l);background:var(--surface);margin-bottom:6px;cursor:pointer;transition:all .1s}
.chat-row:hover{border-color:var(--border);box-shadow:var(--shadow-s)}
.chat-row-spine{width:3px;align-self:stretch;background:var(--border);flex-shrink:0}
.chat-row-info{flex:1;min-width:0}
.chat-row-title{font-size:.82rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.chat-row-sub{font-size:.62rem;color:var(--faint);margin-top:2px}
.chat-row-size{font-size:.6rem;color:var(--faint);flex-shrink:0}

/* ì´ë¯¸ì§€ ê·¸ë¦¬ë“œ */
.img-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
.img-card{border:1px solid var(--border-l);background:var(--surface);cursor:pointer;overflow:hidden;transition:all .1s}
.img-card:hover{border-color:var(--border);box-shadow:var(--shadow-s)}
.img-card img{width:100%;aspect-ratio:1;object-fit:cover;display:block;background:var(--bg)}
.img-card-name{font-size:.58rem;color:var(--faint);padding:3px 6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;border-top:1px solid var(--border-l)}

/* â•â• READER â•â• */
.rd-head{padding:8px 16px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0}
.rd-head h2{font-size:.85rem;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rd-scroll{flex:1;overflow-y:auto;background:var(--surface)}
.rd-inner{max-width:680px;margin:0 auto;padding:0 0 40px}
.rd-foot{padding:6px 16px;background:var(--surface);border-top:1px solid var(--border);font-size:.6rem;color:var(--faint);flex-shrink:0}

/* â”€â”€ ë©”ì‹œì§€ â€” macRetro ìŠ¤íƒ€ì¼ â”€â”€ */
.m{border-bottom:1px solid var(--border-l)}
.m:last-child{border-bottom:0}
.m-head{display:flex;align-items:center;gap:8px;padding:12px 16px 3px;background:rgba(27,28,30,.03)}
.m.u .m-head{flex-direction:row-reverse}
.m-av{width:34px;height:34px;border:1px solid var(--border);box-shadow:var(--shadow-s);object-fit:cover;flex-shrink:0;background:var(--bg)}
.m-ph{width:34px;height:34px;border:1px solid var(--border);box-shadow:var(--shadow-s);display:flex;align-items:center;justify-content:center;font-size:.7rem;background:var(--bg);flex-shrink:0}
.m-name{font-size:.75rem;font-weight:600;flex:1}.m.u .m-name{text-align:right}
.m-time{font-size:.55rem;color:var(--faint)}
.m-body{font-family:var(--font-read);font-size:.88rem;line-height:1.95;padding:8px 16px 14px;color:var(--text)}
.m-body p{margin-bottom:8px}.m-body p:last-child{margin-bottom:0}
.m-body em{color:var(--dim)}
.m-body blockquote{background:rgba(27,28,30,.03);border-left:2px solid var(--border);padding:6px 10px;margin:6px 0}
.m-body code{background:rgba(27,28,30,.04);border-bottom:1.5px dashed var(--border);padding:0 3px;font-family:inherit;font-size:.9em}
.m-img-wrap{padding:4px 16px 10px;text-align:center}
.m-img{max-width:45%;max-height:400px;object-fit:contain;border:1px solid var(--border);box-shadow:var(--shadow);cursor:pointer}
.m-img:hover{opacity:.9}
.m-sw{font-size:.55rem;color:var(--faint);text-align:center;padding-bottom:4px}

/* â•â• LIGHTBOX â•â• */
.lb{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:9999;align-items:center;justify-content:center;cursor:pointer}
.lb.on{display:flex}
.lb img{max-width:92vw;max-height:92vh;object-fit:contain}
.lb-x{position:absolute;top:12px;right:16px;font-size:1.4rem;color:#fff;cursor:pointer;opacity:.6}.lb-x:hover{opacity:1}

/* â•â• MISC â•â• */
.btn{font-family:inherit;font-size:.72rem;padding:3px 8px;border:1px solid var(--border);background:var(--surface);cursor:pointer;box-shadow:var(--shadow-s);color:var(--text);flex-shrink:0}
.btn:hover{background:var(--hover)}.btn:active{box-shadow:none;transform:translate(1px,1px)}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;color:var(--faint);font-size:.8rem;gap:6px}
@keyframes sp{to{transform:rotate(360deg)}}
.spinner{width:14px;height:14px;border:2px solid var(--border-l);border-top-color:var(--border);border-radius:50%;animation:sp .5s linear infinite;display:inline-block}
.toast-w{position:fixed;bottom:14px;right:14px;z-index:10000}
.toast{padding:5px 12px;background:var(--text);color:var(--surface);font-size:.7rem;box-shadow:var(--shadow);margin-top:4px;animation:fu .2s ease}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* â•â• MOBILE â•â• */
@media(max-width:700px){
  #app{grid-template-columns:1fr}
  .side{position:fixed;left:-240px;top:var(--topbar);bottom:0;width:240px;z-index:200;transition:left .2s ease}
  .side.open{left:0;box-shadow:4px 0 12px rgba(0,0,0,.1)}
  .ham{display:block}
  .ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.2);z-index:199}.ov.show{display:block}
  .m-img{max-width:70%}
  .img-grid{grid-template-columns:repeat(auto-fill,minmax(100px,1fr))}
}
</style>
</head>
<body>
<div id="app">
  <header class="top">
    <button class="ham" onclick="toggleSide()">â˜°</button>
    <div class="top-brand">ì±„íŒ… ë„ì„œê´€<span>Chat Library</span></div>
    <div class="top-spacer"></div>
    <button class="top-btn" onclick="rescan()">â†» ìƒˆë¡œê³ ì¹¨</button>
  </header>

  <nav class="side" id="side">
    <div class="side-search"><input type="text" placeholder="ê²€ìƒ‰..." oninput="filterSide(this.value)"></div>
    <div class="side-label">ì„œì¬</div>
    <ul class="side-list" id="sideList"></ul>
    <div class="side-foot" id="sideFoot">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </nav>
  <div class="ov" id="ov" onclick="toggleSide()"></div>

  <main class="main">
    <div class="vw on" id="vWelcome"><div class="welcome"><b>ğŸ“š ì±„íŒ… ë„ì„œê´€</b><span class="spinner"></span><span id="wMsg">ì„œì¬ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span></div></div>
    <div class="vw" id="vList">
      <div class="cl-head"><button class="btn" onclick="goHome()">â† ì„œì¬</button><h2 id="clTitle"></h2></div>
      <div class="cl-tabs"><button class="cl-tab on" data-t="chats" onclick="switchTab('chats',this)">ì±„íŒ…</button><button class="cl-tab" data-t="imgs" onclick="switchTab('imgs',this)">ì´ë¯¸ì§€</button></div>
      <div class="cl-body" id="clBody"></div>
    </div>
    <div class="vw" id="vReader">
      <div class="rd-head"><button class="btn" onclick="backToList()">â† ëª©ë¡</button><h2 id="rdTitle"></h2></div>
      <div class="rd-scroll" id="rdScroll"><div class="rd-inner" id="rdInner"></div></div>
      <div class="rd-foot" id="rdFoot"></div>
    </div>
  </main>
</div>

<div class="lb" id="lb" onclick="closeLb()"><span class="lb-x">âœ•</span><img id="lbImg" src=""></div>
<div class="toast-w" id="tw"></div>

<script>
const S={chars:{},cur:null,tab:'chats'};

document.addEventListener('DOMContentLoaded',load);

async function load(){
  try{
    const r=await(await fetch('/api/scan')).json();
    S.chars=r.chars||{};
    renderSide();
    const cc=Object.keys(S.chars).length, ch=Object.values(S.chars).reduce((s,c)=>s+c.chatCount,0);
    document.getElementById('sideFoot').textContent=`${cc}ëª… Â· ${ch}í¸ Â· ì´ë¯¸ì§€ ${r.imgTotal}ì¥`;
    document.getElementById('wMsg').textContent='ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”';
    document.querySelector('#vWelcome .spinner').style.display='none';
  }catch(e){document.getElementById('wMsg').textContent='âš  ì„œë²„ ì—°ê²° ì‹¤íŒ¨';}
}

async function rescan(){toast('ìƒˆë¡œê³ ì¹¨...');await load();toast('ì™„ë£Œ');}

// â”€â”€ SIDEBAR â”€â”€
function renderSide(){
  const list=document.getElementById('sideList');
  const entries=Object.entries(S.chars).sort((a,b)=>b[1].chatCount-a[1].chatCount);
  list.innerHTML=entries.map(([n,d])=>{
    const av=d.avatar?`<img class="si-av" src="${d.avatar}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" loading="lazy"><div class="si-ph" style="display:none">${h(n[0])}</div>`:`<div class="si-ph">${h(n[0])}</div>`;
    return `<li class="si ${S.cur===n?'on':''}" onclick="selChar('${h(n)}')" data-s="${h(n.toLowerCase())}">${av}<div class="si-info"><div class="si-name">${h(n)}</div><div class="si-meta">${d.chatCount}í¸${d.imgCount?' Â· '+d.imgCount+'ì¥':''}</div></div><span class="si-badge">${d.chatCount}</span></li>`;
  }).join('');
}

function filterSide(q){const l=q.toLowerCase();document.querySelectorAll('.si').forEach(e=>{e.style.display=(e.dataset.s||'').includes(l)?'':'none'})}

// â”€â”€ VIEWS â”€â”€
function show(id){document.querySelectorAll('.vw').forEach(v=>v.classList.remove('on'));document.getElementById(id).classList.add('on')}
function goHome(){S.cur=null;renderSide();show('vWelcome');closeMobile()}
function backToList(){if(S.cur)selChar(S.cur);else goHome();}

// â”€â”€ CHAR SELECT (ì±„íŒ… ëª©ë¡ + ì´ë¯¸ì§€ íƒ­) â”€â”€
function selChar(n){
  S.cur=n;S.tab='chats';renderSide();closeMobile();
  document.getElementById('clTitle').textContent=n;
  document.querySelectorAll('.cl-tab').forEach(t=>t.classList.toggle('on',t.dataset.t==='chats'));
  renderChatList(n);
  show('vList');
}

function switchTab(tab,el){
  S.tab=tab;
  document.querySelectorAll('.cl-tab').forEach(t=>t.classList.remove('on'));
  el.classList.add('on');
  if(tab==='chats') renderChatList(S.cur);
  else renderCharImgs(S.cur);
}

function renderChatList(n){
  const d=S.chars[n];if(!d)return;
  const body=document.getElementById('clBody');
  const sorted=[...d.chats].sort((a,b)=>(b.mod||'').localeCompare(a.mod||''));
  if(!sorted.length){body.innerHTML='<div class="empty">ì±„íŒ… ì—†ìŒ</div>';return;}
  body.innerHTML=sorted.map(c=>{
    const date=c.mod?fmtDate(c.mod):'';
    const size=c.size?fmtSize(c.size):'';
    return `<div class="chat-row" onclick="openChat('${h(n)}','${h(c.file)}')"><div class="chat-row-spine"></div><div class="chat-row-info"><div class="chat-row-title">${h(c.name)}</div><div class="chat-row-sub">${date}</div></div><div class="chat-row-size">${size}</div></div>`;
  }).join('');
}

async function renderCharImgs(n){
  const body=document.getElementById('clBody');
  body.innerHTML='<div class="empty"><span class="spinner"></span></div>';
  try{
    const r=await(await fetch(`/api/images?char=${encodeURIComponent(n)}`)).json();
    if(!r.images.length){body.innerHTML='<div class="empty">ì´ë¯¸ì§€ ì—†ìŒ</div>';return;}
    body.innerHTML=`<div class="img-grid">${r.images.map(i=>`<div class="img-card" onclick="openLb('${i.url}')"><img src="${i.url}" loading="lazy" onerror="this.parentElement.style.display='none'"><div class="img-card-name">${h(i.name)}</div></div>`).join('')}</div>`;
  }catch(e){body.innerHTML='<div class="empty">ë¡œë“œ ì‹¤íŒ¨</div>';}
}

// â”€â”€ READER â”€â”€
async function openChat(cn,fn){
  show('vReader');
  document.getElementById('rdTitle').textContent=cn;
  document.getElementById('rdInner').innerHTML='<div class="empty"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  document.getElementById('rdFoot').textContent='';
  try{
    const r=await(await fetch(`/api/chat?char=${encodeURIComponent(cn)}&file=${encodeURIComponent(fn)}`)).json();
    if(r.error){toast(r.error);return;}
    document.getElementById('rdTitle').textContent=`${cn} â€” ${r.name}`;
    const c=document.getElementById('rdInner');c.innerHTML='';
    let uc=0,bc=0;
    for(const m of r.msgs){c.appendChild(mkMsg(m,r.avatar));m.is_user?uc++:bc++;}
    document.getElementById('rdFoot').textContent=`${r.msgs.length}í„´ Â· ì‚¬ìš©ì ${uc} Â· AI ${bc}`;
    document.getElementById('rdScroll').scrollTop=0;
  }catch(e){toast('ë¡œë“œ ì‹¤íŒ¨');}
}

function mkMsg(m,av){
  const d=document.createElement('div');d.className=`m${m.is_user?' u':''}`;
  // header
  const hd=document.createElement('div');hd.className='m-head';
  if(m.is_user){const p=document.createElement('div');p.className='m-ph';p.textContent='ğŸ‘¤';hd.appendChild(p);}
  else if(av){const i=document.createElement('img');i.className='m-av';i.src=av;i.loading='lazy';i.onerror=function(){this.style.display='none'};hd.appendChild(i);}
  else{const p=document.createElement('div');p.className='m-ph';p.textContent=m.name?m.name[0]:'?';hd.appendChild(p);}
  const nm=document.createElement('span');nm.className='m-name';nm.textContent=m.name;hd.appendChild(nm);
  if(m.date){const t=document.createElement('span');t.className='m-time';t.textContent=fmtTime(m.date);hd.appendChild(t);}
  d.appendChild(hd);
  // image
  if(m.img){
    const w=document.createElement('div');w.className='m-img-wrap';
    const i=document.createElement('img');i.className='m-img';i.src=m.img;i.loading='lazy';
    i.onclick=()=>openLb(m.img);
    i.onerror=function(){this.parentElement.style.display='none'};
    w.appendChild(i);d.appendChild(w);
  }
  // body
  const b=document.createElement('div');b.className='m-body';b.innerHTML=fmt(m.mes);d.appendChild(b);
  // swipe
  if(m.sw>1){const s=document.createElement('div');s.className='m-sw';s.textContent=`swipe ${m.si+1}/${m.sw}`;d.appendChild(s);}
  return d;
}

function fmt(t){
  if(!t)return'';
  let s=h(t);
  s=s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  s=s.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g,'<em>$1</em>');
  s=s.replace(/^&gt;(.+)$/gm,'<blockquote>$1</blockquote>');
  s=s.replace(/`([^`]+)`/g,'<code>$1</code>');
  s=s.replace(/\n/g,'<br>');
  s=s.replace(/(<br>){2,}/g,'</p><p>');
  return '<p>'+s+'</p>';
}

// â”€â”€ LIGHTBOX â”€â”€
function openLb(src){if(!src)return;document.getElementById('lbImg').src=src;document.getElementById('lb').classList.add('on');}
function closeLb(){document.getElementById('lb').classList.remove('on');}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeLb()});

// â”€â”€ MOBILE â”€â”€
function toggleSide(){document.getElementById('side').classList.toggle('open');document.getElementById('ov').classList.toggle('show');}
function closeMobile(){if(innerWidth<=700){document.getElementById('side').classList.remove('open');document.getElementById('ov').classList.remove('show');}}

// â”€â”€ UTILS â”€â”€
function h(s){return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):''}
function fmtDate(iso){try{const d=new Date(iso);return isNaN(d)?iso:d.toLocaleDateString('ko-KR',{year:'numeric',month:'short',day:'numeric'})}catch{return iso}}
function fmtTime(ds){try{const d=new Date(ds.replace(/@/g,'').replace(/(\d+)h\s*(\d+)m\s*(\d+)s/,'$1:$2:$3'));return isNaN(d)?'':d.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'})}catch{return''}}
function fmtSize(b){return b<1024?b+'B':b<1048576?(b/1024).toFixed(1)+'KB':(b/1048576).toFixed(1)+'MB'}
function toast(msg){const e=document.createElement('div');e.className='toast';e.textContent=msg;document.getElementById('tw').appendChild(e);setTimeout(()=>e.remove(),2500)}
</script>
</body>
</html>
