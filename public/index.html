<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Chat Library ‚Äî Ï±ÑÌåÖ ÎèÑÏÑúÍ¥Ä</title>
<style>
@font-face { font-family: 'RIDIBatang'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.0/RIDIBatang.woff') format('woff'); font-weight: normal; font-display: swap; }
@font-face { font-family: 'SpoqaHanSans'; font-weight: 400; src: url('https://cdn.jsdelivr.net/gh/spoqa/spoqa-han-sans@01ff0283e4f36e159ffbf744b36e16ef742da6d8/Subset/SpoqaHanSans/SpoqaHanSansRegular.woff2') format('woff2'); font-display: swap; }
@font-face { font-family: 'ChangwonDangam'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2511-1@1.0/ChangwonDangamRound-Regular.woff2') format('woff2'); font-weight: normal; font-display: swap; }
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f0ece4; --surface: #faf8f5; --surface-alt: #f5f2ec;
  --text: #2c2c2c; --text-dim: #7a7672; --text-light: #a09a93;
  --border: #d4cfc7; --border-strong: #b0a99f;
  --accent: #5a4a3a; --accent-warm: #8b6f4e;
  --accent-overlay: rgba(90,74,58,0.06); --accent-overlay-strong: rgba(90,74,58,0.12);
  --shadow-soft: 1px 1px 0px rgba(90,74,58,0.1);
  --shadow-card: 0 1px 3px rgba(90,74,58,0.08), 0 1px 2px rgba(90,74,58,0.06);
  --red: #b84233; --tag-bg: #e8e2d8; --tag-text: #6b5d4f;
  --font-body: 'RIDIBatang','SpoqaHanSans',serif;
  --font-display: 'ChangwonDangam','SpoqaHanSans',sans-serif;
  --font-size: 14px; --line-height: 1.9; --radius: 4px; --scrollbar-w: 4px; --topbar-h: 54px;
}
html { font-size: var(--font-size); }
body { font-family: var(--font-body); background: var(--bg); color: var(--text); line-height: var(--line-height); min-height: 100dvh; overflow: hidden; }
::-webkit-scrollbar { width: var(--scrollbar-w); height: var(--scrollbar-w); }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }
#app { display: grid; grid-template-rows: var(--topbar-h) 1fr; grid-template-columns: 280px 1fr; height: 100dvh; width: 100%; }
#topbar { grid-column: 1/-1; display: flex; align-items: center; padding: 0 20px; background: var(--surface); border-bottom: 1px solid var(--border); gap: 16px; z-index: 100; }
#topbar h1 { font-family: var(--font-display); font-size: 1.1rem; font-weight: normal; letter-spacing: 1px; white-space: nowrap; color: var(--accent); }
#topbar h1 .accent { color: var(--text-dim); font-size: 0.85em; margin-left: 8px; }
.topbar-actions { margin-left: auto; display: flex; gap: 8px; align-items: center; }
.btn { font-family: inherit; font-size: 0.82rem; padding: 6px 14px; border: 1px solid var(--border); background: var(--surface); color: var(--text); cursor: pointer; box-shadow: var(--shadow-soft); border-radius: var(--radius); transition: all 0.15s; white-space: nowrap; }
.btn:hover { background: var(--accent-overlay); border-color: var(--border-strong); }
.btn:active { box-shadow: none; transform: translate(1px,1px); }
.btn.primary { background: var(--accent); color: var(--surface); border-color: var(--accent); }
.btn.primary:hover { background: var(--accent-warm); }
.btn.small { padding: 4px 10px; font-size: 0.78rem; }
#sidebar { background: var(--surface); border-right: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; }
.sidebar-section { padding: 12px 14px; }
.sidebar-section + .sidebar-section { border-top: 1px solid var(--accent-overlay); }
.sidebar-title { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-dim); margin-bottom: 8px; padding-left: 3px; position: relative; }
.sidebar-title::before { content: ''; position: absolute; left: -14px; top: 2px; bottom: 2px; width: 3px; background: var(--accent-warm); border-radius: 2px; }
.char-list { list-style: none; }
.char-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; cursor: pointer; border: 1px solid transparent; border-radius: var(--radius); transition: all 0.12s; margin-bottom: 2px; }
.char-item:hover { background: var(--accent-overlay); border-color: var(--border); }
.char-item.active { background: var(--accent-overlay-strong); border-color: var(--border-strong); box-shadow: var(--shadow-soft); }
.char-avatar { width: 38px; height: 38px; border: 1px solid var(--border); border-radius: 50%; box-shadow: var(--shadow-soft); object-fit: cover; flex-shrink: 0; background: var(--surface-alt); }
.char-info { min-width: 0; flex: 1; }
.char-name { font-size: 0.88rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text); }
.char-meta { font-size: 0.72rem; color: var(--text-dim); }
.chat-count { font-size: 0.68rem; background: var(--accent-overlay); border: 1px solid var(--border); padding: 1px 6px; border-radius: 8px; flex-shrink: 0; color: var(--text-dim); }
.search-box { width: 100%; font-family: inherit; font-size: 0.85rem; padding: 8px 12px; border: 1px solid var(--border); background: var(--surface); border-radius: var(--radius); outline: none; transition: border-color 0.15s; }
.search-box:focus { border-color: var(--accent-warm); box-shadow: 0 0 0 2px rgba(139,111,78,0.1); }
.search-box::placeholder { color: var(--text-light); }
#main { display: flex; flex-direction: column; overflow: hidden; position: relative; background: var(--bg); }
#chat-list-panel { display: none; flex-direction: column; overflow: hidden; height: 100%; }
.chat-list-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; background: var(--surface); flex-shrink: 0; }
.char-name-editable { font-size: 1rem; font-weight: 600; color: var(--accent); cursor: pointer; padding: 2px 6px; border: 1px solid transparent; border-radius: var(--radius); transition: all 0.15s; background: transparent; font-family: inherit; outline: none; min-width: 80px; }
.char-name-editable:hover { border-color: var(--border); background: var(--accent-overlay); }
.char-name-editable:focus { border-color: var(--accent-warm); background: var(--surface); box-shadow: 0 0 0 2px rgba(139,111,78,0.1); }
.char-name-edit-hint { font-size: 0.68rem; color: var(--text-light); margin-left: 4px; opacity: 0; transition: opacity 0.15s; }
.chat-list-header:hover .char-name-edit-hint { opacity: 1; }
.tag-bar { display: flex; gap: 6px; padding: 8px 16px; background: var(--surface-alt); border-bottom: 1px solid var(--border); flex-wrap: wrap; align-items: center; flex-shrink: 0; }
.tag-bar-label { font-size: 0.72rem; color: var(--text-dim); margin-right: 4px; white-space: nowrap; }
.tag-chip { font-family: inherit; font-size: 0.72rem; padding: 3px 10px; border: 1px solid var(--border); background: var(--surface); color: var(--tag-text); border-radius: 12px; cursor: pointer; transition: all 0.12s; white-space: nowrap; display: inline-flex; align-items: center; gap: 4px; }
.tag-chip:hover { background: var(--accent-overlay); border-color: var(--border-strong); }
.tag-chip.active { background: var(--accent); color: var(--surface); border-color: var(--accent); }
.tag-chip .tag-count { opacity: 0.7; font-size: 0.65rem; }
.tag-chip.add-tag { border-style: dashed; color: var(--text-light); }
.tag-chip.add-tag:hover { color: var(--text); border-color: var(--accent-warm); }
.chat-entry-tags { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
.chat-tag-mini { font-size: 0.65rem; padding: 1px 6px; background: var(--tag-bg); color: var(--tag-text); border-radius: 8px; cursor: default; border: 1px solid transparent; }
.chat-tag-mini .remove-tag { margin-left: 3px; opacity: 0.5; cursor: pointer; }
.chat-tag-mini .remove-tag:hover { opacity: 1; color: var(--red); }
.chat-entries { flex: 1; overflow-y: auto; padding: 12px 16px; }
.chat-entry { display: flex; align-items: flex-start; gap: 12px; padding: 12px 14px; border: 1px solid var(--border); background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow-card); margin-bottom: 8px; cursor: pointer; transition: all 0.12s; }
.chat-entry:hover { box-shadow: var(--shadow-card), 0 2px 8px rgba(90,74,58,0.08); border-color: var(--border-strong); }
.chat-entry.hidden-by-tag { display: none; }
.chat-entry-icon { font-size: 1.3rem; flex-shrink: 0; width: 32px; text-align: center; padding-top: 2px; }
.chat-entry-info { flex: 1; min-width: 0; }
.chat-entry-name { font-weight: 600; font-size: 0.88rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text); }
.chat-entry-date { font-size: 0.72rem; color: var(--text-dim); margin-top: 2px; }
.chat-entry-preview { font-size: 0.78rem; color: var(--text-dim); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 500px; }
.chat-entry-msgs { font-size: 0.68rem; background: var(--accent-overlay); border: 1px solid var(--border); padding: 2px 8px; border-radius: 8px; flex-shrink: 0; color: var(--text-dim); white-space: nowrap; }
#chat-viewer { display: none; flex-direction: column; height: 100%; overflow: hidden; }
.chat-viewer-header { padding: 10px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; background: var(--surface); flex-shrink: 0; }
.chat-viewer-header h2 { font-size: 0.95rem; font-weight: 600; flex: 1; color: var(--accent); }
.chat-messages { flex: 1; overflow-y: auto; padding: 20px; }
.message { margin-bottom: 16px; display: flex; flex-direction: column; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); box-shadow: var(--shadow-card); overflow: hidden; }
.message.user { background: var(--surface-alt); }
.mes-avatar-wrapper { display: flex; align-items: center; gap: 10px; padding: 10px 16px; background: var(--accent-overlay); border-bottom: 1px solid rgba(90,74,58,0.06); }
.message.user .mes-avatar-wrapper { flex-direction: row-reverse; }
.mes-avatar { width: 40px; height: 40px; border: 1px solid var(--border); border-radius: 50%; box-shadow: var(--shadow-soft); object-fit: cover; flex-shrink: 0; background: var(--surface-alt); }
.mes-name { font-size: 0.84rem; font-weight: 600; flex: 1; color: var(--accent); }
.message.user .mes-name { text-align: right; color: var(--text); }
.mes-time { font-size: 0.7rem; color: var(--text-light); }
.mes-body { padding: 14px 20px 18px 20px; font-size: 0.92rem; line-height: var(--line-height); color: var(--text); }
.mes-body p { margin-bottom: 12px; }
.mes-body p:last-child { margin-bottom: 0; }
.mes-body em { color: var(--text-dim); font-style: italic; }
.mes-body strong { font-weight: 700; color: var(--accent); }
.mes-body blockquote { background: var(--accent-overlay); border-left: 3px solid var(--accent-warm); padding: 10px 14px; margin: 8px 0; border-radius: 0 var(--radius) var(--radius) 0; color: var(--text); font-style: italic; }
.st-infoblock { background: var(--accent-overlay); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px 16px; margin: 8px 0; font-size: 0.85rem; color: var(--text-dim); line-height: 1.7; }
.st-small { font-size: 0.82rem; color: var(--text-dim); line-height: 1.6; }
.st-block { margin: 4px 0; }
.mes-image-container { padding: 0 20px 12px 20px; display: flex; justify-content: center; }
.mes-image { max-width: 45%; max-height: 400px; object-fit: contain; border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-card); cursor: pointer; transition: opacity 0.15s; }
.mes-image:hover { opacity: 0.9; }
.mes-swipe-info { font-size: 0.7rem; color: var(--text-light); text-align: center; padding: 4px 0 8px 0; background: var(--accent-overlay); }
#welcome { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px; text-align: center; }
.welcome-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.7; }
.welcome-title { font-family: var(--font-display); font-size: 1.5rem; margin-bottom: 8px; color: var(--accent); }
.welcome-desc { font-size: 0.88rem; color: var(--text-dim); max-width: 420px; line-height: 1.7; margin-bottom: 24px; }
.drop-zone { border: 2px dashed var(--border-strong); padding: 32px 48px; cursor: pointer; transition: all 0.2s; background: var(--surface); max-width: 500px; width: 100%; border-radius: var(--radius); }
.drop-zone:hover, .drop-zone.drag-over { background: var(--accent-overlay); border-color: var(--accent-warm); box-shadow: var(--shadow-card); }
.drop-zone-text { font-size: 0.85rem; color: var(--text-dim); }
.drop-zone-text strong { color: var(--text); }
#gallery-panel { display: none; flex-direction: column; height: 100%; overflow: hidden; }
.gallery-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; background: var(--surface); flex-shrink: 0; }
.gallery-header h2 { font-size: 1rem; font-weight: 600; flex: 1; color: var(--accent); }
.gallery-folder-bar { display: flex; gap: 6px; padding: 8px 16px; background: var(--surface-alt); border-bottom: 1px solid var(--border); flex-wrap: wrap; align-items: center; flex-shrink: 0; }
.gallery-folder-chip { font-family: inherit; font-size: 0.72rem; padding: 3px 10px; border: 1px solid var(--border); background: var(--surface); color: var(--tag-text); border-radius: 12px; cursor: pointer; transition: all 0.12s; white-space: nowrap; }
.gallery-folder-chip:hover { background: var(--accent-overlay); border-color: var(--border-strong); }
.gallery-folder-chip.active { background: var(--accent); color: var(--surface); border-color: var(--accent); }
.gallery-grid { flex: 1; overflow-y: auto; padding: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; align-content: start; }
.gallery-item { border: 1px solid var(--border); background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow-card); cursor: pointer; transition: all 0.12s; overflow: hidden; }
.gallery-item:hover { box-shadow: var(--shadow-card), 0 4px 12px rgba(90,74,58,0.1); transform: translateY(-1px); }
.gallery-thumb { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; background: var(--bg); }
.gallery-item-info { padding: 6px 8px; border-top: 1px solid var(--accent-overlay); }
.gallery-item-name { font-size: 0.72rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-dim); }
.gallery-item-folder { font-size: 0.65rem; color: var(--text-light); }
.lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center; cursor: pointer; }
.lightbox.open { display: flex; }
.lightbox img { max-width: 90vw; max-height: 90vh; object-fit: contain; box-shadow: 0 4px 30px rgba(0,0,0,0.5); }
.lightbox-close { position: absolute; top: 16px; right: 20px; font-size: 1.8rem; color: white; cursor: pointer; opacity: 0.7; }
.lightbox-close:hover { opacity: 1; }
.stats-bar { padding: 8px 16px; background: var(--surface); border-top: 1px solid var(--border); font-size: 0.72rem; color: var(--text-dim); display: flex; gap: 16px; flex-shrink: 0; }
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-dim); font-size: 0.9rem; gap: 8px; }
.empty-state-icon { font-size: 2rem; opacity: 0.5; }
.sidebar-toggle { display: none; font-size: 1.2rem; background: none; border: none; cursor: pointer; color: var(--text); padding: 4px; }
.hint-text { font-size: 0.72rem; color: var(--text-dim); padding: 8px 0; line-height: 1.5; }
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 9000; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 8px 30px rgba(0,0,0,0.15); padding: 20px; min-width: 300px; max-width: 400px; }
.modal-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 12px; color: var(--accent); }
.modal-input { width: 100%; font-family: inherit; font-size: 0.85rem; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius); outline: none; margin-bottom: 12px; }
.modal-input:focus { border-color: var(--accent-warm); }
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
.existing-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
@media (max-width: 700px) {
  #app { grid-template-columns: 1fr; }
  #sidebar { position: fixed; left: -280px; top: var(--topbar-h); bottom: 0; width: 280px; z-index: 200; transition: left 0.25s ease; }
  #sidebar.open { left: 0; box-shadow: 4px 0 20px rgba(0,0,0,0.15); }
  .sidebar-toggle { display: block; }
  .mes-image { max-width: 80%; }
  .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
  .mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 199; }
  .mobile-overlay.show { display: block; }
}
.toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; }
.toast { padding: 10px 18px; background: var(--accent); color: var(--surface); font-family: inherit; font-size: 0.82rem; border-radius: var(--radius); box-shadow: 0 2px 12px rgba(0,0,0,0.2); margin-top: 6px; animation: toastIn 0.3s ease; }
.toast.error { background: var(--red); }
@keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }
</style>
</head>
<body>
<div id="app">
  <header id="topbar">
    <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Î©îÎâ¥">‚ò∞</button>
    <h1>Chat Library<span class="accent">Ï±ÑÌåÖ ÎèÑÏÑúÍ¥Ä</span></h1>
    <div class="topbar-actions">
      <button class="btn small" onclick="showGallery()">üñº Í∞§Îü¨Î¶¨</button>
      <button class="btn small primary" onclick="triggerFileInput()">Ôºã ÌååÏùº Ï∂îÍ∞Ä</button>
    </div>
  </header>
  <nav id="sidebar">
    <div class="sidebar-section"><input type="text" class="search-box" placeholder="Ï∫êÎ¶≠ÌÑ∞ Í≤ÄÏÉâ..." oninput="filterCharacters(this.value)"></div>
    <div class="sidebar-section" style="flex:1;overflow-y:auto;padding-top:4px;">
      <div class="sidebar-title">Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù</div>
      <ul class="char-list" id="charList"></ul>
    </div>
    <div class="sidebar-section"><div class="sidebar-title">ÌÜµÍ≥Ñ</div><div id="sidebarStats" class="hint-text">ÌååÏùºÏùÑ Î∂àÎü¨ÏôÄ Ï£ºÏÑ∏Ïöî</div></div>
  </nav>
  <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>
  <main id="main">
    <div id="welcome">
      <div class="welcome-icon">üìö</div>
      <div class="welcome-title">Ï±ÑÌåÖ ÎèÑÏÑúÍ¥Ä</div>
      <div class="welcome-desc">Î∞±ÏóÖÌïú SillyTavern Ï±ÑÌåÖ ÌååÏùº(.jsonl)Í≥º Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨ÏôÄÏÑú<br>ÎèÑÏÑúÍ¥ÄÏ≤òÎüº Ïó¥ÎûåÌï† Ïàò ÏûàÏñ¥Ïöî.</div>
      <div class="drop-zone" id="dropZone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)" onclick="triggerFileInput()">
        <div class="drop-zone-text"><strong>ÌååÏùº/Ìè¥ÎçîÎ•º Ïó¨Í∏∞Ïóê ÎìúÎûòÍ∑∏</strong><br>ÎòêÎäî ÌÅ¥Î¶≠Ìï¥ÏÑú ÏÑ†ÌÉù<br><br><span style="font-size:0.78rem">.jsonl (Ï±ÑÌåÖ) ¬∑ .png .jpg .webp (Ïù¥ÎØ∏ÏßÄ)</span></div>
      </div>
      <div class="hint-text" style="margin-top:12px;max-width:420px;">üí° TermuxÏóêÏÑú Î∞±ÏóÖÌïú chats Ìè¥ÎçîÏôÄ user/images Ìè¥ÎçîÎ•º ÌÜµÏß∏Î°ú ÎÑ£ÏúºÎ©¥<br>Ï∫êÎ¶≠ÌÑ∞Î≥ÑÎ°ú ÏûêÎèô Ï†ïÎ¶¨Îê©ÎãàÎã§.</div>
    </div>
    <div id="chat-list-panel">
      <div class="chat-list-header">
        <button class="btn small" onclick="goHome()">‚Üê ÏÑúÏû¨</button>
        <input type="text" class="char-name-editable" id="charNameEdit" onfocus="this.select()" onblur="commitCharNameEdit()" onkeydown="if(event.key==='Enter')this.blur();">
        <span class="char-name-edit-hint">‚úé Ïù¥Î¶Ñ ÏàòÏ†ï</span>
      </div>
      <div class="tag-bar" id="tagBar"></div>
      <div class="chat-entries" id="chatEntries"></div>
    </div>
    <div id="chat-viewer">
      <div class="chat-viewer-header">
        <button class="btn small" onclick="goBackToList()">‚Üê Î™©Î°ùÏúºÎ°ú</button>
        <h2 id="chatViewerTitle">Ï±ÑÌåÖ</h2>
        <span class="mes-time" id="chatViewerDate"></span>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="stats-bar" id="chatStats"></div>
    </div>
    <div id="gallery-panel">
      <div class="gallery-header">
        <button class="btn small" onclick="goHome()">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
        <h2>üñº Ïù¥ÎØ∏ÏßÄ Í∞§Îü¨Î¶¨</h2>
        <span class="mes-time" id="galleryCount"></span>
      </div>
      <div class="gallery-folder-bar" id="galleryFolderBar"></div>
      <div class="gallery-grid" id="galleryGrid"></div>
    </div>
  </main>
</div>
<input type="file" id="fileInput" multiple accept=".jsonl,.json,.png,.jpg,.jpeg,.webp,.gif" style="display:none" onchange="handleFileSelect(event)">
<div class="lightbox" id="lightbox" onclick="closeLightbox()"><span class="lightbox-close">&times;</span><img id="lightboxImg" src="" alt=""></div>
<div class="modal-overlay" id="tagModal"><div class="modal-box" onclick="event.stopPropagation()">
  <div class="modal-title" id="tagModalTitle">ÌÉúÍ∑∏ Ï∂îÍ∞Ä</div>
  <div class="existing-tags" id="tagModalExisting"></div>
  <input type="text" class="modal-input" id="tagModalInput" placeholder="ÏÉà ÌÉúÍ∑∏ Ïù¥Î¶Ñ..." onkeydown="if(event.key==='Enter')addTagFromModal();">
  <div class="modal-actions"><button class="btn small" onclick="closeTagModal()">Ï∑®ÏÜå</button><button class="btn small primary" onclick="addTagFromModal()">Ï∂îÍ∞Ä</button></div>
</div></div>
<div class="toast-container" id="toastContainer"></div>

<script>
const state = {
  characters: {}, images: {}, imageList: [], imageFolders: new Set(),
  currentChar: null, currentChat: null, activeTag: null, activeGalleryFolder: null,
  charTags: {}, allTags: new Set(), charNameMap: {}, tagModalTarget: null, userAvatars: {}
};

function triggerFileInput() { document.getElementById('fileInput').click(); }
function handleDragOver(e) { e.preventDefault(); e.currentTarget?.classList?.add('drag-over'); }
function handleDragLeave(e) { e.currentTarget?.classList?.remove('drag-over'); }

async function handleDrop(e) {
  e.preventDefault();
  e.currentTarget?.classList?.remove('drag-over');
  const items = e.dataTransfer?.items;
  if (!items) return;
  const files = [];
  const promises = [];
  for (const item of items) {
    const entry = item.webkitGetAsEntry?.();
    if (entry) promises.push(traverseEntry(entry, files, ''));
  }
  await Promise.all(promises);
  if (!files.length) for (const f of e.dataTransfer.files) files.push({file:f,folder:''});
  processFiles(files);
}

function traverseEntry(entry, files, parentPath) {
  return new Promise(resolve => {
    if (entry.isFile) {
      entry.file(f => { files.push({file:f,folder:parentPath}); resolve(); });
    } else if (entry.isDirectory) {
      const dirPath = parentPath ? parentPath+'/'+entry.name : entry.name;
      const reader = entry.createReader();
      const readAll = all => {
        reader.readEntries(async entries => {
          if (!entries.length) { for (const e of all) await traverseEntry(e,files,dirPath); resolve(); }
          else { all.push(...entries); readAll(all); }
        });
      };
      readAll([]);
    } else resolve();
  });
}

function handleFileSelect(e) { processFiles(Array.from(e.target.files).map(f=>({file:f,folder:''}))); e.target.value=''; }

async function processFiles(fileEntries) {
  let chatCount=0, imgCount=0;
  for (const entry of fileEntries) {
    const file = entry.file||entry, folder = entry.folder||'', name = file.name.toLowerCase();
    if (name.endsWith('.jsonl')) { await parseChatFile(file); chatCount++; }
    else if (name.endsWith('.json') && !name.includes('settings') && !name.includes('theme')) { await parseChatFile(file); chatCount++; }
    else if (/\.(png|jpg|jpeg|webp|gif)$/i.test(name)) {
      const url = URL.createObjectURL(file);
      state.images[file.name] = url;
      const parts = folder.split('/').filter(Boolean);
      const displayFolder = parts.length ? parts[parts.length-1] : 'Í∏∞ÌÉÄ';
      state.imageList.push({name:file.name, url, folder:displayFolder, fullPath:folder});
      state.imageFolders.add(displayFolder);
      for (const cn of Object.keys(state.characters)) {
        if (!state.characters[cn].avatar) {
          const c1 = cn.toLowerCase().replace(/[^a-z0-9Í∞Ä-Ìû£]/gi,'');
          const c2 = file.name.toLowerCase().replace(/[^a-z0-9Í∞Ä-Ìû£]/gi,'');
          if (c2.includes(c1) && c1.length>=2) state.characters[cn].avatar = url;
        }
      }
      // Track user avatar candidates from user/persona folders
      const lf = folder.toLowerCase();
      if (lf.includes('user') || lf.includes('persona')) {
        const bn = file.name.replace(/\.(png|jpg|jpeg|webp|gif)$/i,'');
        state.userAvatars[bn] = url;
        state.userAvatars[bn.toLowerCase()] = url;
      }
      imgCount++;
    }
  }
  matchAvatars();
  renderSidebar(); updateStats();
  if (chatCount||imgCount) toast(`${chatCount}Í∞ú Ï±ÑÌåÖ ¬∑ ${imgCount}Í∞ú Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏôÑÎ£å`);
  if (Object.keys(state.characters).length) document.getElementById('welcome').style.display='none';
}

function matchAvatars() {
  for (const cn of Object.keys(state.characters)) {
    if (state.characters[cn].avatar) continue;
    const clean = cn.toLowerCase().replace(/\s+/g,'');
    for (const [fn,url] of Object.entries(state.images)) {
      const cf = fn.toLowerCase().replace(/\s+/g,'').replace(/\.(png|jpg|jpeg|webp|gif)$/i,'');
      if (cf===clean || (cf.includes(clean)&&clean.length>=2) || (clean.includes(cf)&&cf.length>=3)) {
        state.characters[cn].avatar = url; break;
      }
    }
  }
}

async function parseChatFile(file) {
  const text = await file.text();
  const lines = text.trim().split('\n');
  if (!lines.length) return;
  const messages = [];
  let chatName = file.name.replace(/\.jsonl?$/,''), charName='', chatDate='', userPersona='';
  for (const line of lines) {
    try {
      const msg = JSON.parse(line.trim());
      if (!charName && msg.name && !msg.is_user) charName = msg.name;
      if (!charName && msg.character_name) charName = msg.character_name;
      if (msg.is_user && msg.name && msg.name!=='ÏÇ¨Ïö©Ïûê') userPersona = msg.name;
      if (!charName) {
        const p = (file.webkitRelativePath||'').split('/');
        if (p.length>=2) charName = p[p.length-2];
      }
      if (!chatDate && msg.send_date) chatDate = msg.send_date;
      if (!chatDate && msg.create_date) chatDate = msg.create_date;
      messages.push({
        name: msg.name||(msg.is_user?'ÏÇ¨Ïö©Ïûê':charName||'???'),
        is_user: !!msg.is_user, mes: msg.mes||'',
        send_date: msg.send_date||msg.create_date||'',
        extra: msg.extra||{}, swipe_id: msg.swipe_id, swipes: msg.swipes
      });
    } catch(e) {}
  }
  if (!messages.length) return;
  if (!charName) { const i=chatName.indexOf(' - '); charName = i>0?chatName.substring(0,i):chatName; }
  charName = charName.replace(/\.png$/i,'');
  if (!state.characters[charName]) state.characters[charName] = {avatar:null, chats:[], userPersona:''};
  if (userPersona) state.characters[charName].userPersona = userPersona;
  state.characters[charName].chats.push({name:chatName, date:chatDate, messages, file:file.name, msgCount:messages.length, tags:[]});
  if (!state.charTags[charName]) state.charTags[charName] = {};
}

// === RENDERING ===
function getDisplayName(n) { return state.charNameMap[n]||n; }

function renderSidebar() {
  const list = document.getElementById('charList');
  const chars = Object.entries(state.characters).sort((a,b) => {
    const at = a[1].chats.reduce((s,c)=>s+c.messages.length,0);
    const bt = b[1].chats.reduce((s,c)=>s+c.messages.length,0);
    return bt-at;
  });
  list.innerHTML = chars.map(([name,data]) => {
    const dn = getDisplayName(name);
    const av = data.avatar
      ? `<img class="char-avatar" src="${data.avatar}" alt="">`
      : `<div class="char-avatar" style="display:flex;align-items:center;justify-content:center;font-size:1.1rem">${dn.charAt(0)}</div>`;
    return `<li class="char-item ${state.currentChar===name?'active':''}" onclick="selectCharacter('${escHtml(name)}')" data-name="${escHtml(name.toLowerCase())} ${escHtml(dn.toLowerCase())}">
      ${av}<div class="char-info"><div class="char-name">${escHtml(dn)}</div><div class="char-meta">${data.chats.length}Í∞ú Ï±ÑÌåÖ</div></div>
      <span class="chat-count">${data.chats.reduce((s,c)=>s+c.messages.length,0)}</span></li>`;
  }).join('');
}

function filterCharacters(q) { q=q.toLowerCase(); document.querySelectorAll('.char-item').forEach(el=>{el.style.display=(el.dataset.name||'').includes(q)?'':'none';}); }

function selectCharacter(name) {
  state.currentChar=name; state.currentChat=null; state.activeTag=null;
  renderSidebar();
  const data = state.characters[name]; if (!data) return;
  hideAllPanels();
  document.getElementById('chat-list-panel').style.display='flex';
  document.getElementById('charNameEdit').value = getDisplayName(name);
  renderTagBar(name); renderChatEntries(name);
  closeSidebarMobile();
}

function commitCharNameEdit() {
  if (!state.currentChar) return;
  const v = document.getElementById('charNameEdit').value.trim();
  if (v && v !== state.currentChar) { state.charNameMap[state.currentChar]=v; renderSidebar(); toast(`Ïù¥Î¶Ñ Î≥ÄÍ≤Ω: ${v}`); }
}

// === TAGS ===
function getTagsForChat(cn,idx) { if(!state.charTags[cn])state.charTags[cn]={}; return state.charTags[cn][idx]||[]; }
function setTagsForChat(cn,idx,tags) { if(!state.charTags[cn])state.charTags[cn]={}; state.charTags[cn][idx]=tags; tags.forEach(t=>state.allTags.add(t)); }

function renderTagBar(cn) {
  const bar=document.getElementById('tagBar'), data=state.characters[cn]; if(!data) return;
  const tc={};
  data.chats.forEach((_,i)=>getTagsForChat(cn,i).forEach(t=>{tc[t]=(tc[t]||0)+1;}));
  let h=`<span class="tag-bar-label">ÌÉúÍ∑∏:</span><span class="tag-chip ${!state.activeTag?'active':''}" onclick="filterByTag(null)">Ï†ÑÏ≤¥ <span class="tag-count">${data.chats.length}</span></span>`;
  for (const [t,c] of Object.entries(tc).sort()) h+=`<span class="tag-chip ${state.activeTag===t?'active':''}" onclick="filterByTag('${escHtml(t)}')">${escHtml(t)} <span class="tag-count">${c}</span></span>`;
  h+=`<span class="tag-chip add-tag" onclick="openAddTagModal()">Ôºã ÌÉúÍ∑∏ Ï∂îÍ∞Ä</span>`;
  bar.innerHTML=h;
}

function filterByTag(t) { state.activeTag=t; if(state.currentChar){renderTagBar(state.currentChar);renderChatEntries(state.currentChar);} }

function renderChatEntries(cn) {
  const data=state.characters[cn], el=document.getElementById('chatEntries');
  const sorted=[...data.chats].map((c,i)=>({chat:c,idx:i})).sort((a,b)=>(b.chat.date||'').localeCompare(a.chat.date||''));
  el.innerHTML=sorted.map(({chat,idx})=>{
    const preview = chat.messages.length>1?chat.messages[1].mes.substring(0,100):'';
    const dateStr = chat.date?formatDate(chat.date):'ÎÇ†Ïßú Î∂àÎ™Ö';
    const tags = getTagsForChat(cn,idx);
    const hidden = state.activeTag && !tags.includes(state.activeTag);
    const tagsHtml = tags.map(t=>`<span class="chat-tag-mini">${escHtml(t)}<span class="remove-tag" onclick="event.stopPropagation();removeTagFromChat('${escHtml(cn)}',${idx},'${escHtml(t)}')">&times;</span></span>`).join('');
    return `<div class="chat-entry ${hidden?'hidden-by-tag':''}" onclick="openChat('${escHtml(cn)}',${idx})">
      <div class="chat-entry-icon">üí¨</div>
      <div class="chat-entry-info"><div class="chat-entry-name">${escHtml(chat.name)}</div><div class="chat-entry-date">${dateStr}</div>
      ${preview?`<div class="chat-entry-preview">${escHtml(preview)}</div>`:''}
      ${tagsHtml?`<div class="chat-entry-tags">${tagsHtml}</div>`:''}</div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        <span class="chat-entry-msgs">${chat.msgCount}ÌÑ¥</span>
        <span class="tag-chip add-tag" style="font-size:0.62rem;padding:1px 6px" onclick="event.stopPropagation();openAddTagModalForChat('${escHtml(cn)}',${idx})">ÔºãÌÉúÍ∑∏</span>
      </div></div>`;
  }).join('');
}

function openAddTagModal() { state.tagModalTarget=null; document.getElementById('tagModalTitle').textContent='Ï†ÑÏ≤¥ ÎèÑÏÑúÏóê ÌÉúÍ∑∏ Ï∂îÍ∞Ä'; showTagModal(); }
function openAddTagModalForChat(cn,i) { state.tagModalTarget={cn,i}; document.getElementById('tagModalTitle').textContent='Ïù¥ ÎèÑÏÑúÏóê ÌÉúÍ∑∏ Ï∂îÍ∞Ä'; showTagModal(); }

function showTagModal() {
  const m=document.getElementById('tagModal'); m.classList.add('open');
  m.onclick=e=>{if(e.target===m)closeTagModal();};
  const ex=document.getElementById('tagModalExisting');
  ex.innerHTML = state.allTags.size ? '<div style="font-size:0.72rem;color:var(--text-dim);margin-bottom:6px">Í∏∞Ï°¥ ÌÉúÍ∑∏ ÌÅ¥Î¶≠:</div>'+
    Array.from(state.allTags).sort().map(t=>`<span class="tag-chip" onclick="pickExistingTag('${escHtml(t)}')">${escHtml(t)}</span>`).join('') : '';
  setTimeout(()=>document.getElementById('tagModalInput').focus(),100);
}
function closeTagModal() { document.getElementById('tagModal').classList.remove('open'); document.getElementById('tagModalInput').value=''; }
function pickExistingTag(t) { applyTag(t); }
function addTagFromModal() { const t=document.getElementById('tagModalInput').value.trim(); if(t)applyTag(t); }

function applyTag(tag) {
  if (state.tagModalTarget) {
    const {cn,i}=state.tagModalTarget, tags=getTagsForChat(cn,i);
    if(!tags.includes(tag)){tags.push(tag);setTagsForChat(cn,i,tags);}
  } else if (state.currentChar) {
    state.characters[state.currentChar].chats.forEach((_,i)=>{
      const tags=getTagsForChat(state.currentChar,i);
      if(!tags.includes(tag)){tags.push(tag);setTagsForChat(state.currentChar,i,tags);}
    });
  }
  state.allTags.add(tag); closeTagModal();
  if(state.currentChar){renderTagBar(state.currentChar);renderChatEntries(state.currentChar);}
  toast(`ÌÉúÍ∑∏ "${tag}" Ï∂îÍ∞ÄÎê®`);
}

function removeTagFromChat(cn,idx,tag) {
  const tags=getTagsForChat(cn,idx), i=tags.indexOf(tag);
  if(i>=0)tags.splice(i,1); setTagsForChat(cn,idx,tags);
  if(state.currentChar){renderTagBar(state.currentChar);renderChatEntries(state.currentChar);}
}

// === CHAT VIEWER ===
function openChat(cn,idx) {
  const data=state.characters[cn]; if(!data||!data.chats[idx]) return;
  state.currentChat=idx; const chat=data.chats[idx];
  hideAllPanels(); document.getElementById('chat-viewer').style.display='flex';
  document.getElementById('chatViewerTitle').textContent=getDisplayName(cn);
  document.getElementById('chatViewerDate').textContent=chat.date?formatDate(chat.date):'';
  const container=document.getElementById('chatMessages'); container.innerHTML='';
  let uM=0,bM=0;
  for (const msg of chat.messages) {
    container.appendChild(createMessageElement(msg, data.avatar, data.userPersona));
    if(msg.is_user)uM++;else bM++;
  }
  document.getElementById('chatStats').textContent=`Ï¥ù ${chat.messages.length}ÌÑ¥ ¬∑ ÏÇ¨Ïö©Ïûê ${uM} ¬∑ AI ${bM}`;
  container.scrollTop=0;
}

function createMessageElement(msg, charAvatar, userPersona) {
  const div=document.createElement('div');
  div.className=`message ${msg.is_user?'user':'bot'}`;
  const aw=document.createElement('div'); aw.className='mes-avatar-wrapper';

  // Avatar
  let avatarEl;
  if (msg.is_user) {
    let uav = null;
    if(msg.name) {
      uav = state.userAvatars[msg.name] || state.userAvatars[msg.name.toLowerCase()];
      if(!uav && userPersona) uav = state.userAvatars[userPersona] || state.userAvatars[userPersona.toLowerCase()];
      if(!uav) {
        const cn=msg.name.toLowerCase().replace(/\s+/g,'');
        for(const [fn,fu] of Object.entries(state.images)){
          const cf=fn.toLowerCase().replace(/\s+/g,'').replace(/\.(png|jpg|jpeg|webp|gif)$/i,'');
          if(cf===cn||(cf.includes(cn)&&cn.length>=2)||(cn.includes(cf)&&cf.length>=3)){uav=fu;break;}
        }
      }
    }
    if(uav){avatarEl=document.createElement('img');avatarEl.className='mes-avatar';avatarEl.src=uav;}
    else{avatarEl=document.createElement('div');avatarEl.className='mes-avatar';avatarEl.style.cssText='display:flex;align-items:center;justify-content:center;font-size:1rem;background:var(--accent-overlay)';avatarEl.textContent='üë§';}
  } else {
    if(charAvatar){avatarEl=document.createElement('img');avatarEl.className='mes-avatar';avatarEl.src=charAvatar;}
    else{avatarEl=document.createElement('div');avatarEl.className='mes-avatar';avatarEl.style.cssText='display:flex;align-items:center;justify-content:center;font-size:1rem;background:var(--accent-overlay)';avatarEl.textContent=msg.name.charAt(0);}
  }
  aw.appendChild(avatarEl);

  const ns=document.createElement('span'); ns.className='mes-name'; ns.textContent=msg.name; aw.appendChild(ns);
  if(msg.send_date){const ts=document.createElement('span');ts.className='mes-time';ts.textContent=formatTime(msg.send_date);aw.appendChild(ts);}
  div.appendChild(aw);

  if(msg.extra?.image){
    const ic=document.createElement('div');ic.className='mes-image-container';
    const img=document.createElement('img');img.className='mes-image';
    if(msg.extra.image.startsWith('data:'))img.src=msg.extra.image;
    else{const f=findImage(msg.extra.image);if(f)img.src=f;else{img.style.display='none';}}
    img.onclick=()=>openLightbox(img.src);ic.appendChild(img);div.appendChild(ic);
  }

  const body=document.createElement('div');body.className='mes-body';body.innerHTML=formatMessage(msg.mes);div.appendChild(body);

  if(msg.swipes?.length>1){const si=document.createElement('div');si.className='mes-swipe-info';si.textContent=`Ïä§ÏôÄÏù¥ÌîÑ ${(msg.swipe_id||0)+1}/${msg.swipes.length}`;div.appendChild(si);}
  return div;
}

function formatMessage(text) {
  if (!text) return '';
  let h = escHtml(text);

  // SillyTavern custom tags ‚Üí CSS classes
  h = h.replace(/&lt;infoblock&gt;([\s\S]*?)&lt;\/infoblock&gt;/gi, '<div class="st-infoblock">$1</div>');
  h = h.replace(/&lt;small&gt;([\s\S]*?)&lt;\/small&gt;/gi, '<span class="st-small">$1</span>');
  h = h.replace(/&lt;div[^&]*?&gt;([\s\S]*?)&lt;\/div&gt;/gi, '<div class="st-block">$1</div>');
  h = h.replace(/&lt;span[^&]*?&gt;([\s\S]*?)&lt;\/span&gt;/gi, '<span>$1</span>');
  h = h.replace(/&lt;center&gt;([\s\S]*?)&lt;\/center&gt;/gi, '<div style="text-align:center">$1</div>');
  h = h.replace(/&lt;hr\s*\/?&gt;/gi, '<hr style="border:none;border-top:1px solid var(--border);margin:12px 0">');
  h = h.replace(/&lt;b&gt;([\s\S]*?)&lt;\/b&gt;/gi, '<strong>$1</strong>');
  h = h.replace(/&lt;i&gt;([\s\S]*?)&lt;\/i&gt;/gi, '<em>$1</em>');
  h = h.replace(/&lt;u&gt;([\s\S]*?)&lt;\/u&gt;/gi, '<u>$1</u>');
  h = h.replace(/&lt;s&gt;([\s\S]*?)&lt;\/s&gt;/gi, '<s>$1</s>');
  // Remove remaining unmatched ST tags
  h = h.replace(/&lt;\/?(?:infoblock|small|div|span|center|details|summary|fieldset|legend|table|tr|td|th|thead|tbody|br\s*\/?|p)&gt;/gi, '');
  // Remove markdown code block markers
  h = h.replace(/`{3,}\s*\w*\s*/g, '');

  h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  h = h.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
  h = h.replace(/^&gt;(.+)$/gm, '<blockquote>$1</blockquote>');
  h = h.replace(/`([^`]+)`/g, '<code style="background:var(--accent-overlay);padding:1px 4px;border-bottom:1.5px dashed var(--accent-warm);font-size:0.9em;border-radius:2px">$1</code>');
  h = h.replace(/\n/g, '<br>');
  h = h.replace(/(<br>){2,}/g, '</p><p>');
  return '<p>'+h+'</p>';
}

function findImage(fn) {
  if(state.images[fn]) return state.images[fn];
  const l=fn.toLowerCase();
  for(const [k,u] of Object.entries(state.images)) if(k.toLowerCase().includes(l)||l.includes(k.toLowerCase())) return u;
  return null;
}

// === GALLERY ===
function showGallery() {
  hideAllPanels(); document.getElementById('gallery-panel').style.display='flex';
  state.activeGalleryFolder=null; renderGalleryFolderBar(); renderGalleryGrid();
}

function renderGalleryFolderBar() {
  const bar=document.getElementById('galleryFolderBar');
  const folders=Array.from(state.imageFolders).sort();
  let h=`<span class="gallery-folder-chip ${!state.activeGalleryFolder?'active':''}" onclick="filterGalleryByFolder(null)">Ï†ÑÏ≤¥ <span style="opacity:0.7;font-size:0.65rem">${state.imageList.length}</span></span>`;
  for(const f of folders){
    const c=state.imageList.filter(i=>i.folder===f).length;
    h+=`<span class="gallery-folder-chip ${state.activeGalleryFolder===f?'active':''}" onclick="filterGalleryByFolder('${escHtml(f)}')">${escHtml(f)} <span style="opacity:0.7;font-size:0.65rem">${c}</span></span>`;
  }
  bar.innerHTML=h;
}

function filterGalleryByFolder(f) { state.activeGalleryFolder=f; renderGalleryFolderBar(); renderGalleryGrid(); }

function renderGalleryGrid() {
  const grid=document.getElementById('galleryGrid');
  const filtered = state.activeGalleryFolder ? state.imageList.filter(i=>i.folder===state.activeGalleryFolder) : state.imageList;
  document.getElementById('galleryCount').textContent=`${filtered.length}Í∞ú Ïù¥ÎØ∏ÏßÄ`;
  if(!filtered.length){grid.innerHTML=`<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">üñº</div><div>Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§</div></div>`;return;}
  grid.innerHTML=filtered.map(img=>`<div class="gallery-item" onclick="openLightbox('${img.url}')">
    <img class="gallery-thumb" src="${img.url}" alt="" loading="lazy">
    <div class="gallery-item-info"><div class="gallery-item-name">${escHtml(img.name)}</div>
    ${img.folder&&img.folder!=='Í∏∞ÌÉÄ'?`<div class="gallery-item-folder">üìÅ ${escHtml(img.folder)}</div>`:''}</div></div>`).join('');
}

// === NAV ===
function hideAllPanels() { ['welcome','chat-list-panel','chat-viewer','gallery-panel'].forEach(id=>document.getElementById(id).style.display='none'); }
function goHome() { state.currentChar=null;state.currentChat=null;renderSidebar();hideAllPanels();document.getElementById('welcome').style.display=''; }
function goBackToList() { state.currentChar?selectCharacter(state.currentChar):goHome(); }
function openLightbox(src) { if(!src)return; document.getElementById('lightboxImg').src=src; document.getElementById('lightbox').classList.add('open'); }
function closeLightbox() { document.getElementById('lightbox').classList.remove('open'); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('mobileOverlay').classList.toggle('show'); }
function closeSidebarMobile() { if(window.innerWidth<=700){document.getElementById('sidebar').classList.remove('open');document.getElementById('mobileOverlay').classList.remove('show');} }

// === UTILS ===
function escHtml(s) { return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'):''; }
function formatDate(d) { try{if(!d)return'';const dt=new Date(d.replace(/@/g,'').replace(/(\d+)h\s*(\d+)m\s*(\d+)s/,'$1:$2:$3'));return isNaN(dt)?d:dt.toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'});}catch{return d;} }
function formatTime(d) { try{if(!d)return'';const dt=new Date(d.replace(/@/g,'').replace(/(\d+)h\s*(\d+)m\s*(\d+)s/,'$1:$2:$3'));return isNaN(dt)?'':dt.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});}catch{return'';} }
function updateStats() {
  const cc=Object.keys(state.characters).length, ch=Object.values(state.characters).reduce((s,c)=>s+c.chats.length,0);
  const msg=Object.values(state.characters).reduce((s,c)=>s+c.chats.reduce((ss,ch)=>ss+ch.messages.length,0),0);
  document.getElementById('sidebarStats').innerHTML=`${cc}Î™Ö Ï∫êÎ¶≠ÌÑ∞ ¬∑ ${ch}Í∞ú Ï±ÑÌåÖ<br>${msg.toLocaleString()}ÌÑ¥ ¬∑ ${state.imageList.length}Í∞ú Ïù¥ÎØ∏ÏßÄ`;
}
function toast(msg,type='success') { const el=document.createElement('div');el.className=`toast ${type}`;el.textContent=msg;document.getElementById('toastContainer').appendChild(el);setTimeout(()=>el.remove(),3500); }

document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeLightbox();closeTagModal();}});
document.addEventListener('DOMContentLoaded',()=>{document.body.addEventListener('dragover',e=>e.preventDefault());document.body.addEventListener('drop',e=>{e.preventDefault();handleDrop(e);});});
</script>
</body>
</html>
