<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ì±„íŒ… ë„ì„œê´€</title>
<style>
/* ============================================================
   Chat Library UI â€” inspired by RIDI Books + macRetro theme
   Clean, editorial, book-like reading experience
   ============================================================ */

@font-face {
  font-family: 'Batang';
  src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.0/RIDIBatang.woff') format('woff');
  font-weight: normal;
  font-display: swap;
}
@font-face {
  font-family: 'Dangam';
  src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2511-1@1.0/ChangwonDangamRound-Regular.woff2') format('woff2');
  font-weight: normal;
  font-display: swap;
}
@font-face {
  font-family: 'Spoqa';
  font-weight: 400;
  src: url('https://cdn.jsdelivr.net/gh/spoqa/spoqa-han-sans@01ff0283e4f36e159ffbf744b36e16ef742da6d8/Subset/SpoqaHanSans/SpoqaHanSansRegular.woff2') format('woff2');
  font-display: swap;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #F4F1EC;
  --bg-warm: #EDE9E1;
  --surface: #FFFFFF;
  --text: #1B1C1E;
  --text-secondary: #6B6B6B;
  --text-faint: #A3A0A0;
  --border: #1B1C1E;
  --border-light: rgba(27,28,30,0.12);
  --accent: #1B1C1E;
  --accent-overlay: rgba(27,28,30,0.04);
  --accent-hover: rgba(27,28,30,0.08);
  --shadow: 2px 2px 0px #1B1C1E;
  --shadow-sm: 1px 1px 0px rgba(27,28,30,0.25);
  --red: #CE3636;
  --user-bg: rgba(27,28,30,0.03);
  --bot-bg: #FFFFFF;

  --font-read: 'Batang', 'Noto Serif KR', Georgia, serif;
  --font-ui: 'Spoqa', 'Apple SD Gothic Neo', sans-serif;
  --font-display: 'Dangam', 'Spoqa', sans-serif;

  --topbar-h: 48px;
  --sidebar-w: 260px;
  --chat-max-w: 720px;
  --radius: 0px;
  --scrollbar-w: 3px;
}

html {
  font-size: 14px;
  -webkit-text-size-adjust: 100%;
}

body {
  font-family: var(--font-ui);
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100dvh;
  overflow: hidden;
}

::-webkit-scrollbar { width: var(--scrollbar-w); }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--accent); }

/* â•â•â•â•â•â•â•â•â•â•â• LAYOUT â•â•â•â•â•â•â•â•â•â•â• */
#app {
  display: grid;
  grid-template-rows: var(--topbar-h) 1fr;
  grid-template-columns: var(--sidebar-w) 1fr;
  height: 100dvh;
}

/* â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  padding: 0 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  gap: 12px;
  z-index: 100;
  position: relative;
}

.topbar-menu {
  display: none;
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  color: var(--text);
  padding: 4px;
}

.topbar-brand {
  font-family: var(--font-display);
  font-size: 0.95rem;
  letter-spacing: 0.5px;
  color: var(--text);
  white-space: nowrap;
}
.topbar-brand small {
  font-family: var(--font-ui);
  color: var(--text-secondary);
  font-size: 0.75rem;
  margin-left: 6px;
  font-weight: normal;
}

.topbar-spacer { flex: 1; }

.topbar-path {
  font-size: 0.7rem;
  color: var(--text-faint);
  font-family: monospace;
  max-width: 300px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.topbar-btn {
  font-family: var(--font-ui);
  font-size: 0.78rem;
  padding: 4px 12px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  transition: background 0.12s;
  white-space: nowrap;
}
.topbar-btn:hover { background: var(--accent-hover); }
.topbar-btn:active { box-shadow: none; transform: translate(1px,1px); }

/* â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â€” ì„œì¬ â•â•â•â•â•â•â•â•â•â•â• */
.sidebar {
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-search {
  padding: 12px;
  border-bottom: 1px solid var(--border-light);
}

.search-input {
  width: 100%;
  font-family: var(--font-ui);
  font-size: 0.8rem;
  padding: 6px 10px;
  border: 1px solid var(--border);
  background: var(--surface);
  box-shadow: var(--shadow-sm);
  outline: none;
}
.search-input:focus { border-color: var(--text); box-shadow: var(--shadow); }
.search-input::placeholder { color: var(--text-faint); }

.sidebar-label {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-faint);
  padding: 10px 14px 6px;
  position: relative;
}
.sidebar-label::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 14px;
  right: 14px;
  height: 1px;
  background: var(--border-light);
}

.sidebar-list {
  flex: 1;
  overflow-y: auto;
  list-style: none;
}

.sidebar-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  cursor: pointer;
  border-left: 3px solid transparent;
  transition: all 0.1s;
}
.sidebar-item:hover {
  background: var(--accent-overlay);
  border-left-color: var(--border-light);
}
.sidebar-item.active {
  background: var(--accent-overlay);
  border-left-color: var(--accent);
}

.sidebar-avatar {
  width: 34px;
  height: 34px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  object-fit: cover;
  flex-shrink: 0;
  background: var(--bg-warm);
}
.sidebar-avatar-placeholder {
  width: 34px;
  height: 34px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.85rem;
  background: var(--bg-warm);
  color: var(--text-secondary);
  flex-shrink: 0;
  font-family: var(--font-display);
}

.sidebar-item-info { flex: 1; min-width: 0; }
.sidebar-item-name {
  font-size: 0.82rem;
  font-weight: 600;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.sidebar-item-meta {
  font-size: 0.65rem;
  color: var(--text-faint);
}

.sidebar-badge {
  font-size: 0.62rem;
  color: var(--text-faint);
  border: 1px solid var(--border-light);
  padding: 1px 5px;
  flex-shrink: 0;
}

.sidebar-footer {
  padding: 10px 14px;
  border-top: 1px solid var(--border-light);
  font-size: 0.65rem;
  color: var(--text-faint);
  line-height: 1.5;
}

/* â•â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â• */
.main {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
  background: var(--bg);
}

/* â”€â”€ VIEWS â”€â”€ */
.view { display: none; flex-direction: column; height: 100%; overflow: hidden; }
.view.active { display: flex; }

/* â•â•â•â•â•â•â•â•â•â•â• WELCOME VIEW â•â•â•â•â•â•â•â•â•â•â• */
.welcome {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  padding: 40px 24px;
  text-align: center;
}
.welcome-icon { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.6; }
.welcome-title { font-family: var(--font-display); font-size: 1.3rem; margin-bottom: 6px; }
.welcome-sub { font-size: 0.82rem; color: var(--text-secondary); max-width: 360px; line-height: 1.7; }
.welcome-loading { margin-top: 24px; }

/* â•â•â•â•â•â•â•â•â•â•â• CHAT LIST VIEW (ì±… ëª©ë¡) â•â•â•â•â•â•â•â•â•â•â• */
.chatlist-header {
  padding: 14px 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.chatlist-header h2 {
  font-size: 0.95rem;
  font-weight: 600;
  flex: 1;
}

.chatlist-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
}

/* ë¦¬ë””ë¶ìŠ¤ ìŠ¤íƒ€ì¼ â€” ì±… í‘œì§€ ì¹´ë“œ */
.book-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 16px;
}

.book-card {
  cursor: pointer;
  transition: transform 0.12s;
}
.book-card:hover { transform: translateY(-2px); }

.book-cover {
  width: 100%;
  aspect-ratio: 3 / 4;
  background: var(--surface);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 16px 12px;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.book-cover-char {
  font-family: var(--font-display);
  font-size: 0.7rem;
  color: var(--text-secondary);
  margin-bottom: 4px;
  letter-spacing: 0.5px;
}

.book-cover-title {
  font-family: var(--font-read);
  font-size: 0.78rem;
  font-weight: 600;
  line-height: 1.4;
  word-break: break-all;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
}

.book-cover-line {
  width: 30px;
  height: 1px;
  background: var(--border);
  margin: 8px 0;
}

.book-cover-msgs {
  font-size: 0.62rem;
  color: var(--text-faint);
}

.book-cover-spine {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: var(--accent);
}

.book-meta {
  padding: 6px 2px;
}
.book-date {
  font-size: 0.65rem;
  color: var(--text-faint);
}

/* â•â•â•â•â•â•â•â•â•â•â• READER VIEW (ì½ê¸° ë·°) â•â•â•â•â•â•â•â•â•â•â• */
.reader-header {
  padding: 10px 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.reader-header h2 {
  font-family: var(--font-read);
  font-size: 0.9rem;
  font-weight: 600;
  flex: 1;
}

.reader-scroll {
  flex: 1;
  overflow-y: auto;
  background: var(--bg);
}

.reader-inner {
  max-width: var(--chat-max-w);
  margin: 0 auto;
  padding: 0 0 60px 0;
}

/* â”€â”€ Message bubbles â€” macRetro ìŠ¤íƒ€ì¼ ì±„íŒ…ì°½ â”€â”€ */
.msg {
  margin: 0;
  border-bottom: 1px solid var(--border-light);
}
.msg:last-child { border-bottom: none; }

.msg-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 14px 18px 4px 18px;
  background: var(--accent-overlay);
}
.msg.is-user .msg-header {
  flex-direction: row-reverse;
}

.msg-avatar {
  width: 36px;
  height: 36px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  object-fit: cover;
  flex-shrink: 0;
  background: var(--bg-warm);
}
.msg-avatar-ph {
  width: 36px;
  height: 36px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  background: var(--bg-warm);
  flex-shrink: 0;
}

.msg-name {
  font-size: 0.78rem;
  font-weight: 600;
  flex: 1;
}
.msg.is-user .msg-name { text-align: right; }

.msg-time {
  font-size: 0.6rem;
  color: var(--text-faint);
}

.msg-body {
  font-family: var(--font-read);
  font-size: 0.88rem;
  line-height: 1.9;
  padding: 10px 18px 16px 18px;
  color: var(--text);
}

.msg-body p { margin-bottom: 10px; }
.msg-body p:last-child { margin-bottom: 0; }
.msg-body em { color: var(--text-secondary); }

.msg-body blockquote {
  background: var(--accent-overlay);
  border-left: 2px solid var(--accent);
  padding: 6px 10px;
  margin: 6px 0;
  color: var(--text);
}

.msg-body code {
  background: var(--accent-overlay);
  border-bottom: 1.5px dashed var(--accent);
  padding: 1px 4px;
  font-family: inherit;
  font-size: 0.9em;
}

/* ì¸ë¼ì¸ ì´ë¯¸ì§€ */
.msg-image-wrap {
  padding: 4px 18px 12px 18px;
  display: flex;
  justify-content: center;
}
.msg-image {
  max-width: 40%;
  max-height: 400px;
  object-fit: contain;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: opacity 0.12s;
}
.msg-image:hover { opacity: 0.9; }

.msg-swipe {
  font-size: 0.6rem;
  color: var(--text-faint);
  text-align: center;
  padding-bottom: 4px;
}

.reader-footer {
  padding: 8px 20px;
  background: var(--surface);
  border-top: 1px solid var(--border);
  font-size: 0.65rem;
  color: var(--text-faint);
  display: flex;
  gap: 12px;
  flex-shrink: 0;
}

/* â•â•â•â•â•â•â•â•â•â•â• GALLERY VIEW â•â•â•â•â•â•â•â•â•â•â• */
.gallery-header {
  padding: 14px 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.gallery-header h2 { font-size: 0.95rem; font-weight: 600; flex: 1; }

.gallery-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
}

.gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
}

.gallery-card {
  border: 1px solid var(--border);
  background: var(--surface);
  box-shadow: var(--shadow-sm);
  cursor: pointer;
  transition: all 0.12s;
  overflow: hidden;
}
.gallery-card:hover { box-shadow: var(--shadow); transform: translateY(-1px); }

.gallery-thumb {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  display: block;
  background: var(--bg-warm);
}
.gallery-card-info {
  padding: 5px 7px;
  border-top: 1px solid var(--border-light);
  font-size: 0.62rem;
  color: var(--text-faint);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* â•â•â•â•â•â•â•â•â•â•â• LIGHTBOX â•â•â•â•â•â•â•â•â•â•â• */
.lightbox {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.88);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}
.lightbox.open { display: flex; }
.lightbox img { max-width: 92vw; max-height: 92vh; object-fit: contain; }
.lightbox-x {
  position: absolute;
  top: 14px;
  right: 18px;
  font-size: 1.5rem;
  color: #fff;
  cursor: pointer;
  opacity: 0.6;
}
.lightbox-x:hover { opacity: 1; }

/* â•â•â•â•â•â•â•â•â•â•â• MISC â•â•â•â•â•â•â•â•â•â•â• */
.back-btn {
  font-family: var(--font-ui);
  font-size: 0.75rem;
  padding: 3px 10px;
  border: 1px solid var(--border);
  background: var(--surface);
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  color: var(--text);
  flex-shrink: 0;
  transition: background 0.1s;
}
.back-btn:hover { background: var(--accent-hover); }
.back-btn:active { box-shadow: none; transform: translate(1px,1px); }

.empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--text-faint);
  font-size: 0.85rem;
  gap: 6px;
}
.empty-icon { font-size: 1.8rem; opacity: 0.4; }

@keyframes spin { to { transform: rotate(360deg); } }
.spinner {
  width: 16px; height: 16px;
  border: 2px solid var(--border-light);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  display: inline-block;
}

.toast-wrap { position: fixed; bottom: 16px; right: 16px; z-index: 10000; }
.toast {
  padding: 6px 14px;
  background: var(--text);
  color: var(--surface);
  font-size: 0.75rem;
  box-shadow: var(--shadow);
  margin-top: 4px;
  animation: fadeUp 0.25s ease;
}
.toast.err { background: var(--red); }
@keyframes fadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:none; } }

/* â•â•â•â•â•â•â•â•â•â•â• MOBILE â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 700px) {
  #app { grid-template-columns: 1fr; }
  .sidebar {
    position: fixed;
    left: -260px;
    top: var(--topbar-h);
    bottom: 0;
    width: 260px;
    z-index: 200;
    transition: left 0.2s ease;
  }
  .sidebar.open { left: 0; box-shadow: 4px 0 16px rgba(0,0,0,0.12); }
  .topbar-menu { display: block; }
  .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:199; }
  .overlay.show { display:block; }

  .msg-image { max-width: 70%; }
  .book-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
  .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
  .topbar-path { display: none; }
}
</style>
</head>
<body>

<div id="app">
  <!-- TOPBAR -->
  <header class="topbar">
    <button class="topbar-menu" onclick="toggleSidebar()">â˜°</button>
    <div class="topbar-brand">ì±„íŒ… ë„ì„œê´€<small>Chat Library</small></div>
    <div class="topbar-spacer"></div>
    <div class="topbar-path" id="topbarPath"></div>
    <button class="topbar-btn" onclick="showGallery()">ğŸ–¼ ê°¤ëŸ¬ë¦¬</button>
    <button class="topbar-btn" onclick="rescan()">â†» ìƒˆë¡œê³ ì¹¨</button>
  </header>

  <!-- SIDEBAR -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-search">
      <input class="search-input" type="text" placeholder="ìºë¦­í„° ê²€ìƒ‰..." oninput="filterChars(this.value)">
    </div>
    <div class="sidebar-label">ì„œì¬</div>
    <ul class="sidebar-list" id="charList"></ul>
    <div class="sidebar-footer" id="sidebarStats">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </nav>

  <!-- MOBILE OVERLAY -->
  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

  <!-- MAIN -->
  <main class="main">
    <!-- Welcome -->
    <div class="view active" id="viewWelcome">
      <div class="welcome">
        <div class="welcome-icon">ğŸ“š</div>
        <div class="welcome-title">ì±„íŒ… ë„ì„œê´€</div>
        <div class="welcome-sub">ë°±ì—…í•œ ì±„íŒ…ë“¤ì„ ë„ì„œê´€ì²˜ëŸ¼ ì •ë¦¬í•´ì„œ ë³´ì—¬ë“œë ¤ìš”.</div>
        <div class="welcome-loading" id="welcomeLoading"><span class="spinner"></span> ì„œì¬ ì •ë¦¬ ì¤‘...</div>
      </div>
    </div>

    <!-- Chat List (ì±… ëª©ë¡) -->
    <div class="view" id="viewChatList">
      <div class="chatlist-header">
        <button class="back-btn" onclick="goHome()">â† ì„œì¬</button>
        <h2 id="chatlistTitle"></h2>
      </div>
      <div class="chatlist-scroll">
        <div class="book-grid" id="bookGrid"></div>
      </div>
    </div>

    <!-- Reader (ì½ê¸°) -->
    <div class="view" id="viewReader">
      <div class="reader-header">
        <button class="back-btn" id="readerBackBtn" onclick="goBackToList()">â† ëª©ë¡</button>
        <h2 id="readerTitle"></h2>
        <span class="msg-time" id="readerDate"></span>
      </div>
      <div class="reader-scroll" id="readerScroll">
        <div class="reader-inner" id="readerInner"></div>
      </div>
      <div class="reader-footer" id="readerFooter"></div>
    </div>

    <!-- Gallery -->
    <div class="view" id="viewGallery">
      <div class="gallery-header">
        <button class="back-btn" onclick="goHome()">â† ì„œì¬</button>
        <h2>ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬</h2>
        <span class="msg-time" id="galleryCount"></span>
      </div>
      <div class="gallery-scroll">
        <div class="gallery-grid" id="galleryGrid"></div>
      </div>
    </div>
  </main>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <span class="lightbox-x">âœ•</span>
  <img id="lightboxImg" src="" alt="">
</div>

<div class="toast-wrap" id="toastWrap"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•
const S = {
  characters: {},
  currentChar: null,
  currentChat: null,
  imageCount: 0,
  roots: [],
};

const API = '';  // same origin

// â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  loadData();
});

async function loadData() {
  try {
    const res = await fetch(API + '/api/scan');
    const data = await res.json();
    S.characters = data.characters || {};
    S.imageCount = data.imageCount || 0;
    S.roots = data.roots || [];

    document.getElementById('topbarPath').textContent = S.roots[0] || '';
    renderSidebar();
    updateStats();
    document.getElementById('welcomeLoading').innerHTML = 'ì™¼ìª½ ì„œì¬ì—ì„œ ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”';
  } catch (e) {
    document.getElementById('welcomeLoading').innerHTML = 'âš  ì„œë²„ ì—°ê²° ì‹¤íŒ¨ â€” <code>node server.js</code> ì‹¤í–‰ í™•ì¸';
    console.error(e);
  }
}

async function rescan() {
  toast('ìƒˆë¡œê³ ì¹¨ ì¤‘...');
  await loadData();
  toast('ì„œì¬ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}

// â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•
function renderSidebar() {
  const list = document.getElementById('charList');
  const entries = Object.entries(S.characters).sort((a, b) => b[1].chatCount - a[1].chatCount);

  list.innerHTML = entries.map(([name, data]) => {
    const isActive = S.currentChar === name;
    const avatarHtml = data.avatar
      ? `<img class="sidebar-avatar" src="${data.avatar}" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" loading="lazy"><div class="sidebar-avatar-placeholder" style="display:none">${esc(name[0])}</div>`
      : `<div class="sidebar-avatar-placeholder">${esc(name[0])}</div>`;

    return `<li class="sidebar-item ${isActive ? 'active' : ''}" onclick="selectChar('${esc(name)}')" data-search="${esc(name.toLowerCase())}">
      ${avatarHtml}
      <div class="sidebar-item-info">
        <div class="sidebar-item-name">${esc(name)}</div>
        <div class="sidebar-item-meta">${data.chatCount}í¸${data.imageCount ? ' Â· ' + data.imageCount + 'ì¥' : ''}</div>
      </div>
      <span class="sidebar-badge">${data.chatCount}</span>
    </li>`;
  }).join('');
}

function filterChars(q) {
  const lower = q.toLowerCase();
  document.querySelectorAll('.sidebar-item').forEach(el => {
    el.style.display = (el.dataset.search || '').includes(lower) ? '' : 'none';
  });
}

function updateStats() {
  const charCount = Object.keys(S.characters).length;
  const chatTotal = Object.values(S.characters).reduce((s, c) => s + c.chatCount, 0);
  document.getElementById('sidebarStats').innerHTML =
    `${charCount}ëª… Â· ${chatTotal}í¸ Â· ì´ë¯¸ì§€ ${S.imageCount}ì¥`;
}

// â•â•â•â•â•â•â•â•â•â•â• VIEWS â•â•â•â•â•â•â•â•â•â•â•
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function goHome() {
  S.currentChar = null;
  S.currentChat = null;
  renderSidebar();
  showView('viewWelcome');
  closeSidebarMobile();
}

function goBackToList() {
  if (S.currentChar) selectChar(S.currentChar);
  else goHome();
}

// â•â•â•â•â•â•â•â•â•â•â• CHAT LIST (ì±… ëª©ë¡) â•â•â•â•â•â•â•â•â•â•â•
function selectChar(name) {
  S.currentChar = name;
  S.currentChat = null;
  renderSidebar();
  closeSidebarMobile();

  const data = S.characters[name];
  if (!data) return;

  document.getElementById('chatlistTitle').textContent = name;

  const sorted = [...data.chats].sort((a, b) => (b.modified || '').localeCompare(a.modified || ''));
  const grid = document.getElementById('bookGrid');

  if (sorted.length === 0) {
    grid.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“­</div>ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤</div>';
  } else {
    grid.innerHTML = sorted.map(chat => {
      const dateStr = chat.modified ? fmtDate(chat.modified) : '';
      const sizeStr = chat.size ? fmtSize(chat.size) : '';
      return `<div class="book-card" onclick="openChat('${esc(name)}', '${esc(chat.file)}')">
        <div class="book-cover">
          <div class="book-cover-spine"></div>
          <div class="book-cover-char">${esc(name)}</div>
          <div class="book-cover-title">${esc(chat.name)}</div>
          <div class="book-cover-line"></div>
          <div class="book-cover-msgs">${sizeStr}</div>
        </div>
        <div class="book-meta">
          <div class="book-date">${dateStr}</div>
        </div>
      </div>`;
    }).join('');
  }

  showView('viewChatList');
}

// â•â•â•â•â•â•â•â•â•â•â• READER (ì½ê¸°) â•â•â•â•â•â•â•â•â•â•â•
async function openChat(charName, fileName) {
  S.currentChat = fileName;

  showView('viewReader');
  document.getElementById('readerTitle').textContent = charName;
  document.getElementById('readerInner').innerHTML = '<div class="empty"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  document.getElementById('readerFooter').textContent = '';

  try {
    const res = await fetch(API + `/api/chat?char=${encodeURIComponent(charName)}&file=${encodeURIComponent(fileName)}`);
    const data = await res.json();
    if (data.error) { toast(data.error, true); return; }

    document.getElementById('readerTitle').textContent = `${charName} â€” ${data.name}`;

    const container = document.getElementById('readerInner');
    container.innerHTML = '';

    let userCount = 0, botCount = 0;

    for (const msg of data.messages) {
      container.appendChild(buildMsg(msg, data.avatar));
      if (msg.is_user) userCount++; else botCount++;
    }

    document.getElementById('readerFooter').textContent =
      `${data.messages.length}í„´ Â· ì‚¬ìš©ì ${userCount} Â· AI ${botCount}`;

    document.getElementById('readerScroll').scrollTop = 0;
  } catch (e) {
    toast('ì±„íŒ… ë¡œë“œ ì‹¤íŒ¨', true);
    console.error(e);
  }
}

function buildMsg(msg, charAvatar) {
  const div = document.createElement('div');
  div.className = `msg ${msg.is_user ? 'is-user' : ''}`;

  // Header
  const header = document.createElement('div');
  header.className = 'msg-header';

  if (msg.is_user) {
    const ph = document.createElement('div');
    ph.className = 'msg-avatar-ph';
    ph.textContent = 'ğŸ‘¤';
    header.appendChild(ph);
  } else if (charAvatar) {
    const img = document.createElement('img');
    img.className = 'msg-avatar';
    img.src = charAvatar;
    img.alt = '';
    img.loading = 'lazy';
    img.onerror = function() { this.style.display='none'; };
    header.appendChild(img);
  } else {
    const ph = document.createElement('div');
    ph.className = 'msg-avatar-ph';
    ph.textContent = msg.name ? msg.name[0] : '?';
    header.appendChild(ph);
  }

  const nameEl = document.createElement('span');
  nameEl.className = 'msg-name';
  nameEl.textContent = msg.name;
  header.appendChild(nameEl);

  if (msg.send_date) {
    const timeEl = document.createElement('span');
    timeEl.className = 'msg-time';
    timeEl.textContent = fmtTime(msg.send_date);
    header.appendChild(timeEl);
  }

  div.appendChild(header);

  // Image (SillyTavern extra.image â€” base64 or filename)
  if (msg.extra && msg.extra.image) {
    const wrap = document.createElement('div');
    wrap.className = 'msg-image-wrap';
    const img = document.createElement('img');
    img.className = 'msg-image';
    img.loading = 'lazy';

    if (msg.extra.image.startsWith('data:') || msg.extra.image.startsWith('http')) {
      img.src = msg.extra.image;
    } else {
      // ì„œë²„ì—ì„œ ì´ë¯¸ì§€ ì°¾ê¸° ì‹œë„
      img.src = `/api/image?path=${encodeURIComponent(msg.extra.image)}`;
      img.onerror = function() { this.parentElement.style.display = 'none'; };
    }

    img.onclick = () => openLightbox(img.src);
    wrap.appendChild(img);
    div.appendChild(wrap);
  }

  // Body
  const body = document.createElement('div');
  body.className = 'msg-body';
  body.innerHTML = fmtMsg(msg.mes);
  div.appendChild(body);

  // Swipe
  if (msg.swipes > 1) {
    const sw = document.createElement('div');
    sw.className = 'msg-swipe';
    sw.textContent = `ìŠ¤ì™€ì´í”„ ${(msg.swipe_id || 0) + 1}/${msg.swipes}`;
    div.appendChild(sw);
  }

  return div;
}

function fmtMsg(text) {
  if (!text) return '';
  let h = esc(text);
  h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  h = h.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
  h = h.replace(/^&gt;(.+)$/gm, '<blockquote>$1</blockquote>');
  h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
  h = h.replace(/\n/g, '<br>');
  h = h.replace(/(<br>){2,}/g, '</p><p>');
  return '<p>' + h + '</p>';
}

// â•â•â•â•â•â•â•â•â•â•â• GALLERY â•â•â•â•â•â•â•â•â•â•â•
async function showGallery() {
  showView('viewGallery');
  closeSidebarMobile();

  const grid = document.getElementById('galleryGrid');
  grid.innerHTML = '<div class="empty"><span class="spinner"></span></div>';

  try {
    const res = await fetch(API + '/api/images');
    const data = await res.json();
    const images = data.images || [];

    document.getElementById('galleryCount').textContent = `${images.length}ì¥`;

    if (images.length === 0) {
      grid.innerHTML = '<div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ–¼</div>ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }

    grid.innerHTML = images.map(img => `
      <div class="gallery-card" onclick="openLightbox('${img.url}')">
        <img class="gallery-thumb" src="${img.url}" alt="" loading="lazy" onerror="this.parentElement.style.display='none'">
        <div class="gallery-card-info">${esc(img.name)}</div>
      </div>
    `).join('');
  } catch (e) {
    grid.innerHTML = '<div class="empty">ê°¤ëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â• LIGHTBOX â•â•â•â•â•â•â•â•â•â•â•
function openLightbox(src) {
  if (!src) return;
  document.getElementById('lightboxImg').src = src;
  document.getElementById('lightbox').classList.add('open');
}
function closeLightbox() {
  document.getElementById('lightbox').classList.remove('open');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeLightbox(); });

// â•â•â•â•â•â•â•â•â•â•â• SIDEBAR MOBILE â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('overlay').classList.toggle('show');
}
function closeSidebarMobile() {
  if (window.innerWidth <= 700) {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.remove('show');
  }
}

// â•â•â•â•â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•â•â•â•â•
function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function fmtDate(iso) {
  try {
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    return d.toLocaleDateString('ko-KR', { year:'numeric', month:'short', day:'numeric' });
  } catch { return iso; }
}

function fmtTime(ds) {
  try {
    const d = new Date(ds.replace(/@/g,'').replace(/(\d+)h\s*(\d+)m\s*(\d+)s/,'$1:$2:$3'));
    if (isNaN(d)) return '';
    return d.toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit' });
  } catch { return ''; }
}

function fmtSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/(1024*1024)).toFixed(1) + ' MB';
}

function toast(msg, isErr) {
  const el = document.createElement('div');
  el.className = `toast ${isErr ? 'err' : ''}`;
  el.textContent = msg;
  document.getElementById('toastWrap').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}
</script>
</body>
</html>
